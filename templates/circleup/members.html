<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Members</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:#f5f5f5;display:flex;overflow:hidden}
    
    /* LEFT SIDEBAR - menggunakan style dari sidebar.html */
    .sidebar {
      width: 200px; height: 100vh; background:#e8e8e8;
      display:flex; flex-direction:column; padding:30px 0; position:fixed;
      z-index: 1000;
    }
    
    .logo { font-size:32px; font-weight:bolder; font-style: italic; color:#333; padding:0 25px; margin-bottom:30px; }
    .menu { flex:1; display:flex; flex-direction:column; }
    .menu-item {
      display:flex; align-items:center; padding:15px 25px; color:#555; text-decoration:none;
      font-size:15px; font-weight:400; transition:.3s ease; cursor:pointer; border:none; background:none; width:100%; text-align:left;
    }
    .menu-item svg { width:28px; height:28px; margin-right:20px; fill:#555; transition:fill .3s ease; }
    .menu-item:hover { background:rgba(255,152,0,.1); }
    .menu-item.active { background:#e59d2c; color:#fff; font-weight:600; }
    .menu-item.active svg { fill:#fff; }
    .dropdown { position:relative; }
    .dropdown-menu {
      position:absolute; left:100%; top:0; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.15);
      border-radius:8px; min-width:200px; opacity:0; visibility:hidden; transform:translateX(-10px);
      transition:.3s ease; z-index:10001; overflow:hidden;
    }
    .dropdown-menu.show { opacity:1; visibility:visible; transform:translateX(10px); }
    .dropdown-item { 
      display:block; padding:15px 20px; color:#333; text-decoration:none; 
      font-size:16px; background:none; border:none; width:100%; text-align:left; 
      cursor:pointer; transition: background-color 0.2s;
    }
    .dropdown-item:hover { background:#f5f5f5; }
    .profile-section { padding:0 25px; margin-top:auto; }
    .profile { 
      display:flex; align-items:center; padding:15px 0; color:#555; 
      text-decoration:none; font-size:15px; cursor:pointer; transition: opacity 0.2s;
    }
    .profile:hover { opacity: 0.7; }
    .profile-icon { 
      width:40px; height:40px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
      border-radius:50%; margin-right:15px; display:flex; align-items:center; justify-content:center;
      overflow: hidden; position: relative;
    }
    .profile-icon svg { width:24px; height:24px; fill:#fff; z-index: 1; }
    .profile-icon img {
      width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 2;
    }

    /* Main Container */
    .main-container{display:flex;flex:1;height:100vh;margin-left:200px}

    .members-container{
      flex:1;display:flex;flex-direction:column;background:#fff;overflow:hidden;
    }

    /* Header */
    .members-header{
      padding:20px 40px;background:#f5f5f5;border-bottom:1px solid #e0e0e0;
      display:flex;justify-content:space-between;align-items:center;
    }
    .header-left{flex:1}
    .header-title{font-size:24px;font-weight:600;color:#333}
    .header-stats{font-size:14px;color:#666;margin-top:4px}

    /* Two Column Layout */
    .members-body{
      flex:1;display:flex;min-height:0;background:#fff;
    }

    /* Left Rail - Community List (PERUBAHAN BESAR DI SINI) */
    .left-rail{
      width:280px;padding:16px 10px;border-right:1px solid #eee;
      background:#fff;overflow-y:auto;flex-shrink:0;
    }
    .left-rail::-webkit-scrollbar{width:8px}
    .left-rail::-webkit-scrollbar-thumb{background:#e4e4e4;border-radius:8px}
    
    .community-card{
      display:flex;align-items:center;gap:10px;padding:12px;
      margin-bottom:12px;border-radius:10px;background:#f9f9f9;
      cursor:pointer;transition:all .2s;border-left:3px solid transparent;
    }
    .community-card:hover{background:#f0f0f0}
    .community-card.active{background:#fff3e0;border-left-color:#e59d2c}
    .community-thumb{width:50px;height:50px;border-radius:8px;object-fit:cover;flex-shrink:0}
    .community-info{flex:1;min-width:0}
    .community-title{font-size:14px;font-weight:600;color:#333;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .community-subtitle{font-size:11px;color:#666;margin-top:2px}

    /* Members List */
    .members-main{
      flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;
    }
    .members-content{padding:30px 40px;flex:1;overflow:auto}

    .member-item{
      display:flex;align-items:center;justify-content:space-between;
      padding:20px;background:#f9f9f9;border-radius:12px;margin-bottom:12px;
      transition:background-color .2s ease;
    }
    .member-item:hover{background:#f0f0f0}

    .member-info{display:flex;align-items:center;gap:15px;flex:1}
    .member-avatar{width:45px;height:45px;border-radius:50%;object-fit:cover}
    .member-details{display:flex;flex-direction:column}
    .member-name{
      font-size:15px;font-weight:600;color:#333;
      display:flex;align-items:center;gap:8px;
    }
    .member-badge{
      font-size:12px;font-weight:600;color:#e59d2c;
      background:#fff3e0;padding:3px 10px;border-radius:12px;
    }
    .member-badge.creator{background:#ffe5e5;color:#e74c3c}

    .member-actions{display:flex;gap:10px}
    .action-button{
      padding:8px 20px;border:none;border-radius:20px;
      font-size:13px;font-weight:500;cursor:pointer;
      transition:.3s;font-family:'Poppins',sans-serif;
    }
    .action-button.admin{background:#e59d2c;color:#fff}
    .action-button.admin:hover{background:#d48b1f}
    .action-button.kick{background:#333;color:#fff}
    .action-button.kick:hover{background:#555}
    .action-button.remove{background:#f5f5f5;color:#e74c3c}
    .action-button.remove:hover{background:#ffe5e5}
    .action-button:disabled{opacity:0.5;cursor:not-allowed}

    /* RIGHT SIDEBAR - menggunakan style dari right-sidebar.html */
    .right-sidebar{
      flex:0 0 320px;width:320px;height:100vh;overflow:auto;
      background:#f9f9f9;border-left:1px solid #eee;padding:16px
    }
    .community-header{margin-bottom:12px}
    .community-cover{width:100%;height:150px;object-fit:cover;border-radius:12px;background:#eaeaea}
    .community-name{font-weight:700;font-size:18px;margin-top:10px}
    .community-stats{font-size:13px;color:#666;margin-top:4px}

    .sidebar-menu{list-style:none;margin:12px 0 8px 0;padding:0}
    .sidebar-menu-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;text-decoration:none;color:#333}
    .sidebar-menu-item:hover{background:#fff}
    .sidebar-menu-item.active{background:#fff3e0;border:1px solid #e59d2c}
    .sidebar-menu-item svg{width:18px;height:18px;flex:0 0 18px;fill:currentColor}

    .sidebar-section{margin-top:14px}
    .section-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;color:#666;padding:8px 0}
    .section-toggle svg{width:16px;height:16px;fill:currentColor}
    .sidebar-section-title{font-size:14px;font-weight:600}
    #channels-list,#events-list{margin-top:6px}
    .channel-item,.event-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;text-decoration:none;color:#333}
    .channel-item:hover,.event-item:hover{background:#fff}
    .channel-item.active{background:#f5f5f5}
    .channel-item svg,.event-item svg{width:16px;height:16px;flex:0 0 16px;fill:currentColor}

    .loading{text-align:center;padding:40px;color:#666}
    .error{text-align:center;padding:40px;color:#e74c3c}

    @media (max-width: 1024px){
      .sidebar{display:none}
      .main-container{margin-left:0}
      .left-rail{display:none}
    }
  </style>
</head>
<body>

  <!-- LEFT SIDEBAR - menggunakan struktur dari sidebar.html -->
  <aside class="sidebar">
    <div class="logo">CircleUP</div>

    <nav class="menu">
      <a href="/home/" class="menu-item">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>Home</span>
      </a>

      <a href="/explore/" class="menu-item">
        <svg viewBox="0 0 24 24"><path d="M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z"/></svg>
        <span>Explore</span>
      </a>

      <a href="/chat/" class="menu-item">
        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        <span>Community</span>
      </a>

      <a href="/notifications/" class="menu-item">
        <svg viewBox="0 0 24 24">
          <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
        </svg>
        <span>Notifications</span>
      </a>

      <div class="dropdown">
        <button class="menu-item" id="moreBtn">
          <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
          <span>More</span>
        </button>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="/change-password/" class="dropdown-item">Change Password</a>
          <button class="dropdown-item" onclick="handleLogout()">Log Out</button>
        </div>
      </div>
    </nav>

    <div class="profile-section">
      <a href="/profile/" class="profile">
        <div class="profile-icon" id="sidebarProfileIcon">
          <svg viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
        </div>
        <span id="sidebarProfileName">Profile</span>
      </a>
    </div>
  </aside>

  <div class="main-container">
    <div class="members-container">
      <!-- Header -->
      <div class="members-header">
        <div class="header-left">
          <div class="header-title" id="communityName">Loading...</div>
          <div class="header-stats" id="memberStats"></div>
        </div>
      </div>

      <!-- Body: Left Rail + Members List -->
      <div class="members-body">
        <!-- Left Rail: Community List (PERUBAHAN DARI MEDIA GALLERY KE COMMUNITY LIST) -->
        <aside class="left-rail" id="leftRail">
          <!-- Community list akan diisi di sini -->
        </aside>

        <!-- Members List -->
        <div class="members-main">
          <div class="members-content" id="membersContent">
            <div class="loading">Loading members...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT SIDEBAR - menggunakan struktur dari right-sidebar.html -->
    <aside id="rightSidebar" class="right-sidebar">
      <div class="community-header">
        <img data-rs="image" class="community-cover" id="communityBanner" alt="Community banner">
        <div data-rs="name" class="community-name" id="sidebarCommunityName">Community</div>
        <div data-rs="counts" class="community-stats" id="sidebarStats"></div>
      </div>

      <ul class="sidebar-menu">
        <li>
          <a href="#" class="sidebar-menu-item" onclick="navigateToAbout()">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            <span>About</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-menu-item" onclick="navigateToEvents()">
            <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
            <span>Event Info</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-menu-item" onclick="navigateToFeeds()">
            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            <span>Feeds</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-menu-item active">
            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            <span>Members</span>
          </a>
        </li>
      </ul>

      <div class="sidebar-section">
        <div class="section-toggle" onclick="toggleSection('channels')">
          <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
          <div class="sidebar-section-title">CHANNELS</div>
        </div>
        <div id="channels-list"></div>
      </div>

      <div class="sidebar-section">
        <div class="section-toggle" onclick="toggleSection('events')">
          <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
          <div class="sidebar-section-title">EVENTS</div>
        </div>
        <div id="events-list"></div>
      </div>
    </aside>
  </div>

<script>
(function(){
  const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api";
  const ACCESS = localStorage.getItem("access");
  
  if (!ACCESS) {
    window.location.href = "/login/";
    return;
  }
  
  const H = { 
    Authorization: `Bearer ${ACCESS}`,
    "Content-Type": "application/json"
  };

  const params = new URLSearchParams(location.search);
  let COMMUNITY_ID = params.get("community");
  
  let currentUser = null;
  let communityData = null;
  let isCurrentUserAdmin = false;
  let allMembers = [];

  // Helper: absolute URL for media
  const abs = (u) => {
    if (!u) return "https://via.placeholder.com/150?text=No+Image";
    if (u.startsWith("http")) return u;
    const root = API_BASE.replace(/\/api\/?$/, "");
    return root + (u.startsWith("/") ? "" : "/") + u;
  };

  // Get current user
  async function getCurrentUser() {
    try {
      const r = await fetch(`${API_BASE}/users/profile/`, { headers: H });
      if (!r.ok) throw new Error("Failed to get current user");
      currentUser = await r.json();
      return currentUser;
    } catch (e) {
      console.error("Get current user error:", e);
      return null;
    }
  }

  // Get community details
  async function getCommunity(commId) {
    try {
      const r = await fetch(`${API_BASE}/communities/${commId}/`, { headers: H });
      if (!r.ok) throw new Error("Failed to get community");
      communityData = await r.json();
      
      // Check if current user is admin or creator
      if (currentUser && communityData.created_by) {
        isCurrentUserAdmin = String(currentUser.id) === String(communityData.created_by.id);
      }
      
      if (communityData.user_role === 'admin') {
        isCurrentUserAdmin = true;
      }
      
      return communityData;
    } catch (e) {
      console.error("Get community error:", e);
      return null;
    }
  }

  // PERUBAHAN: Get community members (bukan semua users)
  async function getCommunityMembers(communityId) {
    try {
      // Ambil data community untuk mendapatkan info members
      const r = await fetch(`${API_BASE}/communities/${communityId}/`, { headers: H });
      if (!r.ok) throw new Error("Failed to get community");
      const community = await r.json();
      
      // Di sini kita perlu endpoint khusus untuk members, tapi karena tidak ada,
      // kita simulasikan dengan data yang ada
      // Idealnya: GET /api/communities/{id}/members/
      
      return community;
    } catch (e) {
      console.error("Get community members error:", e);
      return null;
    }
  }

  // PERUBAHAN: Load joined communities for LEFT RAIL (bukan sidebar kiri)
  async function loadCommunityList() {
    try {
      const r = await fetch(`${API_BASE}/communities/joined/`, { headers: H });
      if (!r.ok) return;
      const communities = await r.json();
      
      const box = document.getElementById("leftRail");
      if (!communities || !communities.length) {
        box.innerHTML = '<div style="color:#888;padding:10px;font-size:12px">No communities</div>';
        return;
      }
      
      box.innerHTML = communities.map(c => `
        <div class="community-card ${String(c.id) === String(COMMUNITY_ID) ? 'active' : ''}" 
             data-id="${c.id}" onclick="switchCommunity('${c.id}')">
          <img class="community-thumb" src="${abs(c.profile_pic)}" alt="${c.name}">
          <div class="community-info">
            <div class="community-title">${c.name}</div>
            <div class="community-subtitle">${c.member_count || 0} members</div>
          </div>
        </div>
      `).join("");
    } catch (e) {
      console.error("Load community list error:", e);
    }
  }

  // Switch community
  window.switchCommunity = function(communityId) {
    window.location.href = `?community=${communityId}`;
  };

  // Render header
  function renderHeader(community) {
    document.getElementById("communityName").textContent = community.name || "Community";
    document.getElementById("memberStats").textContent = 
      `${community.member_count || 0} Members · ${community.online_count || 0} Online`;
  }

  // Render right sidebar
  function renderRightSidebar(community) {
    const banner = document.getElementById("communityBanner");
    const name = document.getElementById("sidebarCommunityName");
    const stats = document.getElementById("sidebarStats");
    
    banner.src = abs(community.background_banner || community.profile_pic);
    name.textContent = community.name || "Community";
    stats.textContent = `${community.member_count || 0} Members · ${community.online_count || 0} Online`;
  }

  // Render channels
  async function renderChannels() {
    try {
      const r = await fetch(`${API_BASE}/channels/`, { headers: H });
      const data = await r.json();
      const channels = Array.isArray(data) ? data : (data.results || []);
      
      const communityChannels = channels.filter(c => 
        String(c.community) === String(COMMUNITY_ID)
      );
      
      const box = document.getElementById("channels-list");
      if (!communityChannels.length) {
        box.innerHTML = '<div style="color:#888;padding:6px;font-size:12px">No channels</div>';
        return;
      }
      
      box.innerHTML = communityChannels.map(c => `
        <a href="/chat/?community=${COMMUNITY_ID}&channel=${c.id}" class="channel-item">
          <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
          <span>${c.name}</span>
        </a>
      `).join("");
    } catch (e) {
      console.error("Render channels error:", e);
    }
  }

  // Render events
  async function renderEvents() {
    try {
      const r = await fetch(`${API_BASE}/events/`, { headers: H });
      const events = await r.json();
      
      const communityEvents = (Array.isArray(events) ? events : []).filter(e => 
        e.community && String(e.community.id) === String(COMMUNITY_ID)
      );
      
      const box = document.getElementById("events-list");
      if (!communityEvents.length) {
        box.innerHTML = '<div style="color:#888;padding:6px;font-size:12px">No events</div>';
        return;
      }
      
      box.innerHTML = communityEvents.map(ev => `
        <a href="/event-info/?community=${COMMUNITY_ID}#${ev.id}" class="event-item">
          <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7 10h5v5H7z"/></svg>
          <span>${ev.name}</span>
        </a>
      `).join("");
    } catch (e) {
      console.error("Render events error:", e);
    }
  }

  // PERUBAHAN: Render members dari community yang dipilih
  async function renderMembers() {
    const content = document.getElementById("membersContent");
    
    try {
      // Cara 1: Jika ada endpoint khusus members (ideal)
      // const r = await fetch(`${API_BASE}/communities/${COMMUNITY_ID}/members/`, { headers: H });
      
      // Cara 2: Gunakan data dari community (workaround)
      // Karena tidak ada endpoint members, kita simulasikan
      const allUsersResponse = await fetch(`${API_BASE}/users/`, { headers: H });
      const allUsersData = await allUsersResponse.json();
      const allUsers = Array.isArray(allUsersData) ? allUsersData : (allUsersData.results || []);
      
      // Build member list: creator first
      const members = [];
      
      // Add creator
      if (communityData.created_by) {
        members.push({
          user: communityData.created_by,
          role: 'creator',
          is_online: true
        });
      }
      
      // Add current user if not creator
      if (currentUser && String(currentUser.id) !== String(communityData.created_by?.id)) {
        members.push({
          user: currentUser,
          role: communityData.user_role || 'member',
          is_online: true
        });
      }
      
      // Add some other users as members (sample - dalam produksi ini harus dari endpoint members)
      const otherUsers = allUsers
        .filter(u => 
          String(u.id) !== String(communityData.created_by?.id) && 
          String(u.id) !== String(currentUser?.id)
        )
        .slice(0, 6);
      
      otherUsers.forEach(u => {
        members.push({
          user: u,
          role: Math.random() > 0.7 ? 'admin' : 'member',
          is_online: Math.random() > 0.5
        });
      });
      
      allMembers = members;
      
      content.innerHTML = members.map((m, idx) => {
        const user = m.user;
        const role = m.role;
        const isCreator = role === 'creator';
        const isAdmin = role === 'admin';
        const isCurrentUserMember = String(user.id) === String(currentUser?.id);
        
        let badge = '';
        if (isCreator) badge = '<span class="member-badge creator">Creator</span>';
        else if (isAdmin) badge = '<span class="member-badge">Admin</span>';
        
        let actions = '';
        // Only show actions if current user is admin AND target is not creator or self
        if (!isCreator && !isCurrentUserMember && isCurrentUserAdmin) {
          if (isAdmin) {
            actions = `
              <button class="action-button remove" onclick="handleRemoveAdmin(${idx})">Remove Admin</button>
              <button class="action-button kick" onclick="handleKick(${idx})">Kick</button>
            `;
          } else {
            actions = `
              <button class="action-button admin" onclick="handleMakeAdmin(${idx})">Make Admin</button>
              <button class="action-button kick" onclick="handleKick(${idx})">Kick</button>
            `;
          }
        }
        
        return `
          <div class="member-item" data-member-idx="${idx}">
            <div class="member-info">
              <img src="${abs(user.profile_pic)}" alt="${user.username}" class="member-avatar">
              <div class="member-details">
                <div class="member-name">
                  ${user.username || user.first_name || user.email}
                  ${badge}
                </div>
              </div>
            </div>
            ${actions ? `<div class="member-actions">${actions}</div>` : ''}
          </div>
        `;
      }).join("");
    } catch (e) {
      console.error("Render members error:", e);
      content.innerHTML = '<div class="error">Failed to load members</div>';
    }
  }

  // Handle make admin (client-side simulation)
  window.handleMakeAdmin = function(idx) {
    if (!confirm('Make this member an admin?')) return;
    
    const member = allMembers[idx];
    member.role = 'admin';
    
    alert('Member promoted to admin successfully!\n\nNote: This is a demo. In production, this would call:\nPOST /api/communities/{id}/make_admin/');
    renderMembers();
  };

  // Handle remove admin (client-side simulation)
  window.handleRemoveAdmin = function(idx) {
    if (!confirm('Remove admin privileges from this member?')) return;
    
    const member = allMembers[idx];
    member.role = 'member';
    
    alert('Admin privileges removed successfully!\n\nNote: This is a demo. In production, this would call:\nPOST /api/communities/{id}/remove_admin/');
    renderMembers();
  };

  // Handle kick (client-side simulation)
  window.handleKick = function(idx) {
    if (!confirm('Are you sure you want to kick this member from the community?')) return;
    
    allMembers.splice(idx, 1);
    
    alert('Member kicked successfully!\n\nNote: This is a demo. In production, this would call:\nPOST /api/communities/{id}/kick_member/');
    renderMembers();
  };

  // Toggle section for right sidebar
  window.toggleSection = function(sectionId) {
    const list = document.getElementById(sectionId + '-list');
    if (!list) return;
    list.style.display = (list.style.display === 'none' ? 'block' : 'none');
  };

  // Navigation functions
  window.navigateToAbout = function() {
    window.location.href = `/about/?community=${COMMUNITY_ID}`;
  };

  window.navigateToEvents = function() {
    window.location.href = `/event-info/?community=${COMMUNITY_ID}`;
  };

  window.navigateToFeeds = function() {
    window.location.href = `/feeds/?community=${COMMUNITY_ID}`;
  };

  // Dropdown toggle for sidebar
  const moreBtn = document.getElementById('moreBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');
  if (moreBtn && dropdownMenu) {
    moreBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      dropdownMenu.classList.toggle('show');
      this.classList.toggle('active');
    });
    
    document.addEventListener('click', function(e) {
      if (!moreBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.remove('show');
        moreBtn.classList.remove('active');
      }
    });
  }

  // Load user profile for sidebar
  async function loadSidebarProfile() {
    const token = localStorage.getItem('access');
    if (!token) return;

    const cachedProfile = localStorage.getItem('sidebarProfile');
    if (cachedProfile) {
      try {
        const user = JSON.parse(cachedProfile);
        updateSidebarProfile(user);
      } catch (e) {
        console.error('Error parsing cached profile:', e);
      }
    }

    try {
      const response = await fetch(`${API_BASE}/users/profile/`, { headers: H });
      if (response.ok) {
        const user = await response.json();
        localStorage.setItem('sidebarProfile', JSON.stringify(user));
        updateSidebarProfile(user);
      }
    } catch (error) {
      console.error('Error loading sidebar profile:', error);
    }
  }

  function updateSidebarProfile(user) {
    const profileIcon = document.getElementById('sidebarProfileIcon');
    const profileName = document.getElementById('sidebarProfileName');
    
    if (!profileIcon || !profileName) return;

    profileName.textContent = user.first_name || 'Profile';

    let profilePicUrl = null;
    if (user.profile_pic) {
      profilePicUrl = user.profile_pic.startsWith('http') 
        ? user.profile_pic 
        : `${API_BASE.replace(/\/api\/?$/, "")}${user.profile_pic}`;
    } else {
      profilePicUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.first_name + ' ' + user.last_name)}&size=80&background=667eea&color=fff`;
    }

    const existingImg = profileIcon.querySelector('img');
    if (existingImg) {
      existingImg.remove();
    }

    const img = document.createElement('img');
    img.src = profilePicUrl;
    img.alt = 'Profile';
    img.onerror = function() {
      this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.first_name + ' ' + user.last_name)}&size=80&background=667eea&color=fff`;
    };
    profileIcon.appendChild(img);

    const svg = profileIcon.querySelector('svg');
    if (svg) {
      svg.style.display = 'none';
    }
  }

  // Handle logout
  window.handleLogout = async function() {
    if (!confirm('Are you sure you want to log out?')) {
      return;
    }

    try {
      const refreshToken = localStorage.getItem('refresh');
      const accessToken = localStorage.getItem('access');
      
      if (refreshToken && accessToken) {
        try {
          await fetch(`${API_BASE}/auth/jwt/blacklist/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              refresh: refreshToken
            })
          });
        } catch (apiError) {
          console.warn('API blacklist call failed:', apiError);
        }
      }

      localStorage.removeItem('access');
      localStorage.removeItem('refresh');
      localStorage.removeItem('currentUser');
      localStorage.removeItem('API_BASE');
      localStorage.removeItem('sidebarProfile');
      
      window.location.href = "/login/";
      
    } catch (error) {
      console.error('Logout error:', error);
      localStorage.removeItem('access');
      localStorage.removeItem('refresh');
      localStorage.removeItem('currentUser');
      localStorage.removeItem('API_BASE');
      localStorage.removeItem('sidebarProfile');
      window.location.href = "/login/";
    }
  };

  // Initialize
  async function init() {
    try {
      // Get current user first
      await getCurrentUser();
      
      // Load sidebar profile
      await loadSidebarProfile();
      
      // If no community ID, try to get first joined community
      if (!COMMUNITY_ID) {
        const r = await fetch(`${API_BASE}/communities/joined/`, { headers: H });
        const communities = await r.json();
        if (communities && communities.length > 0) {
          COMMUNITY_ID = communities[0].id;
          const url = new URL(window.location);
          url.searchParams.set('community', COMMUNITY_ID);
          window.history.replaceState({}, '', url);
        } else {
          document.getElementById("membersContent").innerHTML = 
            '<div class="error">No communities found. Please join a community first.</div>';
          return;
        }
      }
      
      const community = await getCommunity(COMMUNITY_ID);
      
      if (!community) {
        document.getElementById("membersContent").innerHTML = 
          '<div class="error">Failed to load community</div>';
        return;
      }
      
      renderHeader(community);
      renderRightSidebar(community);
      await loadCommunityList(); // Load communities di left rail
      await renderMembers();
      await renderChannels();
      await renderEvents();
      
    } catch (e) {
      console.error("Init error:", e);
      document.getElementById("membersContent").innerHTML = 
        '<div class="error">Failed to load page: ' + e.message + '</div>';
    }
  }

  init();
})();
</script>

</body>
</html>