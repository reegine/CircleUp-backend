<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CircleUP - Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Guard PALING AWAL: kalau belum login, langsung redirect ke /login/ -->
  <script>
    (function () {
      if (!localStorage.getItem("access")) {
        window.location.replace("/login/");
      }
    })();
  </script>

  <style>
    :root{
      --brand:#e59d2c;
      --bg:#f5f5f5;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --radius:12px;
      --shadow:0 2px 10px rgba(0,0,0,.08);
      --sidebar-w:200px;
      --gap:24px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
    }

    /* ===== LAYOUT ===== */
    .page{
      margin-left:var(--sidebar-w);   /* ruang untuk sidebar include */
      min-height:100vh;
      width:100%;
      display:grid;
      grid-template-columns: 1fr minmax(320px,420px); /* feed | right panel */
      gap:var(--gap);
      padding:24px;
    }

    /* container kiri (feed) */
    .feed-col{
      max-width:860px;
      width:100%;
    }

    /* container kanan (join communities) */
    .right-col{
      width:100%;
      height:max-content;
      position:sticky;
      top:50px;
      align-self:start;
    }

    /* ===== STORIES (ketika sudah join komunitas) ===== */
    .stories{
      display:flex;
      gap:14px;
      overflow-x:auto;
      padding-bottom:8px;
      margin-bottom:18px;
    }
    .stories::-webkit-scrollbar{height:6px}
    .stories::-webkit-scrollbar-thumb{background:#ddd;border-radius:6px}

    .story{
      flex:0 0 auto;
      width:120px;
      text-align:center;
    }
    .story img{
      width:120px;height:120px;border-radius:12px;object-fit:cover;margin-bottom:6px;box-shadow:var(--shadow)
    }
    .story .name{font-size:12px;color:#333;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* ===== POST CARD ===== */
    .post{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      margin-bottom:16px;
    }
    .post .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .post .user{display:flex;align-items:center;gap:12px}
    .post .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover}
    .post .meta h4{font-size:16px;margin-bottom:2px}
    .post .meta .time{font-size:12px;color:var(--muted)}
    .post .badge{background:#fff3e0;color:var(--brand);font-weight:600;border-radius:20px;padding:6px 12px;font-size:12px}
    .post .image{width:100%;border-radius:10px;margin:10px 0}
    .post .actions{display:flex;gap:10px;margin:6px 0 8px}
    .btn-react{
      border:none;border-radius:20px;padding:8px 14px;font-size:14px;cursor:pointer;background:#f1f1f1;
      transition:transform .15s ease
    }
    .btn-react.love{background:#ffeaa7}
    .btn-react:active{transform:scale(0.96)}
    .post .caption{font-size:14px}

    /* ===== EMPTY STATE (ketika belum join komunitas) ===== */
    .empty{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:48px 28px;
      text-align:center;
      gap:12px;
      margin-top:24px;
    }
    .empty .icon{
      width:72px;height:72px;border-radius:20px;background:#f3f3f3;
      display:flex;align-items:center;justify-content:center;font-size:36px
    }
    .empty h2{font-size:20px}
    .empty p{font-size:13px;color:grey}
    .empty .cta{
      border:none;background:var(--brand);color:#fff;border-radius:999px;padding:10px 16px;font-weight:600;cursor:pointer
    }

    /* ===== RIGHT PANEL ===== */
    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .panel h3{font-size:18px;margin-bottom:10px}
    .c-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
    .c-item:last-child{border-bottom:none}
    .c-info{display:flex;align-items:center;gap:12px}
    .c-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover}
    .c-name{font-size:14px;font-weight:600}
    .c-members{font-size:12px;color:var(--muted)}
    .btn-join{
      border:none;background:#2f2f2f;color:#fff;border-radius:999px;padding:8px 14px;font-weight:600;cursor:pointer
    }
    .show-more{margin-top:6px;font-size:13px;color:#666;text-align:center;cursor:pointer}

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1100px){
      .page{grid-template-columns:1fr}
      .right-col{position:static}
    }
  </style>
</head>
<body>

  {% include "circleup/sidebar.html" %}

  <main class="page">
    <section class="feed-col">
      <div id="stories" class="stories"></div>
      <div id="feed"></div>

      <div id="empty" class="empty" style="display:none">
        <div class="icon">üëã</div>
        <h2>Welcome aboard!</h2>
        <p>Mulai jelajahi komunitas yang cocok sama vibe kamu.</p>
        <button class="cta" onclick="window.location.href='/explore/'">Explore</button>
      </div>
    </section>

    <aside class="right-col">
      <div class="panel" id="joinPanel">
        <h3>Join Communities!</h3>
        <p id="joinLoading" style="color:#666">Loading suggestions‚Ä¶</p>
        <div id="joinList"></div>
        <div id="joinMore" class="show-more" style="display:none">Show more</div>
      </div>
    </aside>
  </main>

  <!-- ===== SCRIPT ===== -->
  <script>
    // Konfigurasi dasar
    const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api";
    const ACCESS   = localStorage.getItem("access") || ""; // sudah dicek di head; ini aman
    const authHeaders = { "Authorization": `Bearer ${ACCESS}`, "Content-Type": "application/json" };

    const toAbs = (u) => {
      if (!u) return "";
      if (u.startsWith("http")) return u;
      const root = API_BASE.replace(/\/api\/?$/,"");
      return `${root}${u.startsWith("/")?"":"/"}${u}`;
    };

    // Elemen
    const storiesEl = document.getElementById("stories");
    const feedEl    = document.getElementById("feed");
    const emptyEl   = document.getElementById("empty");
    const joinList  = document.getElementById("joinList");
    const joinMore  = document.getElementById("joinMore");
    const joinLoad  = document.getElementById("joinLoading");

    // Boot
    (async function boot(){
      try{
        const [meR, homeR] = await Promise.all([
          fetch(`${API_BASE}/users/profile/`, { headers: authHeaders }),
          fetch(`${API_BASE}/home/`,          { headers: authHeaders }),
        ]);

        // kalau token invalid/expired ‚Üí logout & redirect
        if (meR.status === 401 || homeR.status === 401) throw new Error("Unauthorized");

        if (!meR.ok) throw new Error("Unauthorized");
        if (!homeR.ok) throw new Error("Gagal memuat feed");

        const home = await homeR.json(); // { joined_communities, posts, suggestions }
        const joined = home.joined_communities || [];
        const posts  = home.posts || [];
        const sugg   = home.suggestions || [];

        if (joined.length > 0) {
          renderStories(joined);
          renderPosts(posts);
          emptyEl.style.display = "none";
          storiesEl.style.display = "flex";
        } else {
          storiesEl.style.display = "none";
          feedEl.innerHTML = "";
          emptyEl.style.display = "flex";
        }

        renderSuggestions(sugg);
      } catch (e){
        console.warn(e);
        localStorage.removeItem("access");
        localStorage.removeItem("refresh");
        window.location.replace("/login/");
      }
    })();

    /* ===== RENDERERS ===== */
    function renderStories(items){
      storiesEl.innerHTML = items.slice(0,10).map(c=>`
        <div class="story" title="${c.name||''}">
          <img src="${toAbs(c.profile_pic) || 'https://via.placeholder.com/120x120?text=%20'}" alt="${c.name||''}">
          <div class="name">${c.name||''}</div>
        </div>
      `).join("");
    }

    function renderPosts(list){
      if(!list.length){
        feedEl.innerHTML = `<p style="color:#666">Belum ada post dari komunitas yang kamu ikuti.</p>`;
        return;
      }
      feedEl.innerHTML = list.map(p=>{
        const u = p.posted_by || p.user || {};
        const c = p.community || {};
        const t = p.created_at ? new Date(p.created_at).toLocaleString() : "";
        return `
          <article class="post">
            <div class="head">
              <div class="user">
                <img class="avatar" src="${toAbs(u.profile_pic) || 'https://via.placeholder.com/90?text=%20'}" alt="">
                <div class="meta">
                  <h4>${u.username || u.email || "User"}</h4>
                  <div class="time">${t}</div>
                </div>
              </div>
              <div class="badge">${c.name || "Community"}</div>
            </div>

            ${p.image ? `<img class="image" src="${toAbs(p.image)}" alt="">` : ""}

            <div class="actions">
              <button class="btn-react love" data-id="${p.id}" data-type="love">‚ù§Ô∏è</button>
              <button class="btn-react like" data-id="${p.id}" data-type="like">üëç</button>
            </div>

            <div class="caption"><strong>${u.username || "User"}</strong> ${p.caption || ""}</div>
          </article>
        `;
      }).join("");

      // delegasi klik
      feedEl.addEventListener("click", async (e)=>{
        const btn = e.target.closest(".btn-react");
        if(!btn) return;
        const id   = btn.dataset.id;
        const type = btn.dataset.type;
        try{
          if(type==="like"){
            await fetch(`${API_BASE}/posts/${id}/like/`, { method:"POST", headers:authHeaders });
          }else{
            await fetch(`${API_BASE}/posts/${id}/react/`, {
              method:"POST", headers:authHeaders, body:JSON.stringify({ reaction_type:type })
            });
          }
          btn.style.transform="scale(1.06)";
          setTimeout(()=>btn.style.transform="",140);
        }catch{
          alert("Gagal mengirim reaksi.");
        }
      }, { once:true });
    }

    function renderSuggestions(sugg){
      joinLoad.style.display = "none";
      if(!sugg.length){
        joinList.innerHTML = `<p style="color:#666">Tidak ada saran komunitas.</p>`;
        return;
      }
      joinList.innerHTML = sugg.slice(0,5).map(c=>`
        <div class="c-item">
          <div class="c-info">
            <img class="c-avatar" src="${toAbs(c.profile_pic) || 'https://via.placeholder.com/90?text=%20'}" alt="">
            <div>
              <div class="c-name">${c.name||''}</div>
              <div class="c-members">${(c.member_count ?? c.members?.length) || 0} members</div>
            </div>
          </div>
          <button class="btn-join" data-id="${c.id}">Join</button>
        </div>
      `).join("");
      joinMore.style.display = "block";

      joinList.addEventListener("click", async (e)=>{
        const btn = e.target.closest(".btn-join");
        if(!btn) return;
        btn.disabled = true;
        try{
          await fetch(`${API_BASE}/communities/${btn.dataset.id}/join/`, { method:"POST", headers:authHeaders });
          btn.textContent = "Joined ‚úì";
        }catch{
          btn.disabled = false;
          alert("Gagal join komunitas.");
        }
      }, { once:true });
    }
  </script>
</body>
</html>
