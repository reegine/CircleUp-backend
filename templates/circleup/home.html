<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CircleUP - Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Guard PALING AWAL: kalau belum login, langsung redirect ke /login/ -->
  <script>
    (function () {
      if (!localStorage.getItem("access")) {
        window.location.replace("/login/");
      }
    })();
  </script>

  <style>
    :root{
      --brand:#e59d2c;
      --bg:#f5f5f5;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --radius:12px;
      --shadow:0 2px 10px rgba(0,0,0,.08);
      --sidebar-w:200px;
      --gap:24px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
    }

    /* ===== LAYOUT ===== */
    .page{
      margin-left:var(--sidebar-w);
      min-height:100vh;
      width:calc(100% - var(--sidebar-w));
      display:flex;
      justify-content:center;
      gap:var(--gap);
      padding:24px;
    }

    /* container kiri (feed) */
    .feed-col{
      flex:1;
      max-width:600px;
      min-width:400px;
    }

    /* container kanan (join communities) */
    .right-col{
      width:300px;
      flex-shrink:0;
      height:max-content;
      position:sticky;
      top:24px;
      align-self:start;
      margin-left: 80px;
    }

    /* ===== STORIES ===== */
    .stories{
      display:flex;
      gap:16px;
      overflow-x:auto;
      padding-bottom:12px;
      margin-bottom:20px;
    }
    .stories::-webkit-scrollbar{height:6px}
    .stories::-webkit-scrollbar-thumb{background:#ddd;border-radius:6px}

    .story{
      flex:0 0 auto;
      width:160px;
      cursor:pointer;
      transition:transform .2s ease;
      background:#ffffff;
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 3px 10px rgba(0,0,0,.1);
    }
    .story:hover{
      transform:translateY(-3px);
      box-shadow:var(--shadow);
    }
    
    .story-container{
      width:100%;
      height:100px;
      overflow:hidden;
      position:relative;
    }
    
    .story-container img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    
    .story .name{
      font-size:14px;
      color:#333;
      font-weight:600;
      padding:12px 14px;
      background:#ffffff;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ===== POST CARD ===== */
    .post{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      margin-bottom:16px;
    }
    .post .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .post .user{display:flex;align-items:center;gap:12px}
    .post .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover}
    .post .meta h4{font-size:16px;margin-bottom:2px}
    .post .meta .time{font-size:12px;color:var(--muted)}
    .post .badge{background:#fff3e0;color:var(--brand);font-weight:600;border-radius:20px;padding:6px 12px;font-size:12px}
    .post .image{width:100%;border-radius:10px;margin:10px 0}
    
    /* ===== REACTION WRAPPER ===== */
    .post .reaction-wrapper{
      position:relative;
      display:inline-block;
      margin:12px 0;
    }
    
    /* Main reaction button */
    .main-reaction-btn{
      border:none;
      border-radius:25px;
      padding:8px 16px;
      font-size:16px;
      cursor:pointer;
      background:#f1f1f1;
      transition:all .2s ease;
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:500;
      color:#666;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    
    .main-reaction-btn:hover{
      background:#e8e8e8;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,.12);
    }
    
    .main-reaction-btn.reacted{
      background:#ffd93d;
      color:#333;
    }
    
    /* Reaction Picker Popup */
    .reaction-picker{
      position:absolute;
      bottom:calc(100% + 8px);
      left:0;
      background:white;
      border-radius:30px;
      padding:8px 12px;
      box-shadow:0 4px 20px rgba(0,0,0,.15);
      display:none;
      gap:6px;
      z-index:100;
      animation:popIn .2s ease;
    }
    
    @keyframes popIn{
      from{
        opacity:0;
        transform:scale(0.8) translateY(10px);
      }
      to{
        opacity:1;
        transform:scale(1) translateY(0);
      }
    }
    
    .reaction-picker.show{
      display:flex;
    }
    
    .reaction-option{
      border:none;
      background:transparent;
      font-size:32px;
      cursor:pointer;
      padding:2px 4px;
      border-radius:50%;
      transition:all .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      width:48px;
      height:48px;
    }
    
    .reaction-option:hover{
      transform:scale(1.3);
      background:#f5f5f5;
    }
    
    .reaction-option:active{
      transform:scale(1.1);
    }
    

    
    .post .caption{font-size:14px;margin-top:8px}

    /* ===== EMPTY STATE ===== */
    .empty{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:48px 28px;
      text-align:center;
      gap:12px;
      margin-top:24px;
    }
    .empty .icon{
      width:72px;height:72px;border-radius:20px;background:#f3f3f3;
      display:flex;align-items:center;justify-content:center;font-size:36px
    }
    .empty h2{font-size:20px}
    .empty p{font-size:13px;color:grey}
    .empty .cta{
      border:none;background:var(--brand);color:#fff;border-radius:999px;padding:10px 16px;font-weight:600;cursor:pointer
    }

    /* ===== RIGHT PANEL ===== */
    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .panel h3{font-size:18px;margin-bottom:10px}
    .c-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
    .c-item:last-child{border-bottom:none}
    .c-info{display:flex;align-items:center;gap:12px}
    .c-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover}
    .c-name{font-size:14px;font-weight:600}
    .c-members{font-size:12px;color:var(--muted)}
    .btn-join{
      border:none;background:#2f2f2f;color:#fff;border-radius:999px;padding:8px 14px;font-weight:600;cursor:pointer
    }
    .show-more{margin-top:6px;font-size:13px;color:#666;text-align:center;cursor:pointer}

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1200px){
      .page{
        flex-direction:column;
        align-items:center;
      }
      .feed-col{
        width:100%;
        max-width:600px;
      }
      .right-col{
        position:static;
        width:100%;
        max-width:600px;
      }
    }
    
    @media (max-width: 768px){
      .page{
        margin-left:0;
        width:100%;
      }
      .feed-col, .right-col{
        max-width:100%;
      }
      .reaction-option{
        font-size:28px;
        width:44px;
        height:44px;
      }
    }
  </style>
</head>
<body>

  {% include "circleup/sidebar.html" %}

  <main class="page">
    <section class="feed-col">
      <div id="stories" class="stories"></div>
      <div id="feed"></div>

      <div id="empty" class="empty" style="display:none">
        <div class="icon">ðŸ‘‹</div>
        <h2>Welcome aboard!</h2>
        <p>Mulai jelajahi komunitas yang cocok sama vibe kamu.</p>
        <button class="cta" onclick="window.location.href='/explore/'">Explore</button>
      </div>
    </section>

    <aside class="right-col">
      <div class="panel" id="joinPanel">
        <h3>Join Communities!</h3>
        <p id="joinLoading" style="color:#666">Loading suggestionsâ€¦</p>
        <div id="joinList"></div>
        <div id="joinMore" class="show-more" style="display:none">Show more</div>
      </div>
    </aside>
  </main>

  <!-- ===== SCRIPT ===== -->
  <script>
    // Konfigurasi dasar
    const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api";
    const ACCESS   = localStorage.getItem("access") || "";
    const authHeaders = { "Authorization": `Bearer ${ACCESS}`, "Content-Type": "application/json" };

    // Definisi reaction types
    const REACTIONS = [
      { type: 'love', emoji: 'â¤ï¸', label: 'Love' },
      { type: 'like', emoji: 'ðŸ‘', label: 'Like' },
      { type: 'laugh', emoji: 'ðŸ˜‚', label: 'Haha' },
      { type: 'wow', emoji: 'ðŸ˜®', label: 'Wow' },
      { type: 'sad', emoji: 'ðŸ˜¢', label: 'Sad' }
    ];

    const toAbs = (u) => {
      if (!u) return "";
      if (u.startsWith("http")) return u;
      const root = API_BASE.replace(/\/api\/?$/,"");
      return `${root}${u.startsWith("/")?"":"/"}${u}`;
    };

    // Elemen
    const storiesEl = document.getElementById("stories");
    const feedEl    = document.getElementById("feed");
    const emptyEl   = document.getElementById("empty");
    const joinList  = document.getElementById("joinList");
    const joinMore  = document.getElementById("joinMore");
    const joinLoad  = document.getElementById("joinLoading");

    // Boot
    (async function boot(){
      try{
        const [meR, homeR] = await Promise.all([
          fetch(`${API_BASE}/users/profile/`, { headers: authHeaders }),
          fetch(`${API_BASE}/home/`,          { headers: authHeaders }),
        ]);

        if (meR.status === 401 || homeR.status === 401) throw new Error("Unauthorized");
        if (!meR.ok) throw new Error("Unauthorized");
        if (!homeR.ok) throw new Error("Gagal memuat feed");

        const home = await homeR.json();
        const joined = home.joined_communities || [];
        const posts  = home.posts || [];
        const sugg   = home.suggestions || [];

        if (joined.length > 0) {
          renderStories(joined);
          renderPosts(posts);
          emptyEl.style.display = "none";
          storiesEl.style.display = "flex";
        } else {
          storiesEl.style.display = "none";
          feedEl.innerHTML = "";
          emptyEl.style.display = "flex";
        }

        renderSuggestions(sugg);
      } catch (e){
        console.warn(e);
        localStorage.removeItem("access");
        localStorage.removeItem("refresh");
        window.location.replace("/login/");
      }
    })();

    /* ===== RENDERERS ===== */
    function renderStories(items){
      storiesEl.innerHTML = items.slice(0,10).map(c=>`
        <div class="story" title="${c.name||''}" onclick="window.location.href='/community/${c.id}/'">
          <div class="story-container">
            <img src="${toAbs(c.profile_pic) || 'https://via.placeholder.com/160x110?text=%20'}" alt="${c.name||''}">
          </div>
          <div class="name">${c.name||''}</div>
        </div>
      `).join("");
    }

    function renderPosts(list){
      if(!list.length){
        feedEl.innerHTML = `<p style="color:#666">Belum ada post dari komunitas yang kamu ikuti.</p>`;
        return;
      }
      
      feedEl.innerHTML = list.map(p=>{
        const u = p.posted_by || p.user || {};
        const c = p.community || {};
        const t = p.created_at ? new Date(p.created_at).toLocaleString() : "";
        
        // Data dari backend
        const userReaction = p.user_reaction; // 'love', 'like', dll
        const userLiked = p.user_liked;
        
        // Determine current reaction
        let currentReaction = null;
        let buttonText = 'ðŸ˜Š React';
        let buttonClass = '';
        
        if (userReaction) {
          const reaction = REACTIONS.find(r => r.type === userReaction);
          if (reaction) {
            currentReaction = reaction;
            buttonText = `${reaction.emoji} ${reaction.label}`;
            buttonClass = 'reacted';
          }
        } else if (userLiked) {
          const likeReaction = REACTIONS.find(r => r.type === 'like');
          if (likeReaction) {
            currentReaction = likeReaction;
            buttonText = `${likeReaction.emoji} ${likeReaction.label}`;
            buttonClass = 'reacted';
          }
        }
        
        // Generate reaction picker options
        const reactionOptions = REACTIONS.map(r => 
          `<button class="reaction-option" data-type="${r.type}" title="${r.label}">${r.emoji}</button>`
        ).join('');
        
        return `
          <article class="post" data-post-id="${p.id}">
            <div class="head">
              <div class="user">
                <img class="avatar" src="${toAbs(u.profile_pic) || 'https://via.placeholder.com/90?text=%20'}" alt="">
                <div class="meta">
                  <h4>${u.username || u.email || "User"}</h4>
                  <div class="time">${t}</div>
                </div>
              </div>
              <div class="badge">${c.name || "Community"}</div>
            </div>

            ${p.image ? `<img class="image" src="${toAbs(p.image)}" alt="">` : ""}

            <div class="reaction-wrapper" style="margin:12px 0">
              <button class="main-reaction-btn ${buttonClass}" data-post-id="${p.id}">
                ${buttonText}
              </button>
              <div class="reaction-picker">
                ${reactionOptions}
              </div>
            </div>

            <div class="caption"><strong>${u.username || "User"}</strong> ${p.caption || ""}</div>
          </article>
        `;
      }).join("");

      // Setup handlers
      setupReactionHandlers();
    }

    // Setup reaction handlers
    function setupReactionHandlers() {
      // Main button click - toggle picker
      feedEl.addEventListener('click', (e) => {
        const mainBtn = e.target.closest('.main-reaction-btn');
        if (mainBtn) {
          e.stopPropagation();
          const picker = mainBtn.nextElementSibling;
          
          // Close all other pickers
          document.querySelectorAll('.reaction-picker.show').forEach(p => {
            if (p !== picker) p.classList.remove('show');
          });
          
          // Toggle this picker
          picker.classList.toggle('show');
          return;
        }
        
        // Reaction option click
        const reactionOption = e.target.closest('.reaction-option');
        if (reactionOption) {
          e.stopPropagation();
          handleReactionSelect(reactionOption);
          return;
        }
      });
      
      // Close picker when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.reaction-wrapper')) {
          document.querySelectorAll('.reaction-picker.show').forEach(p => {
            p.classList.remove('show');
          });
        }
      });
    }

    // Handle reaction selection
    let isProcessing = false;
    async function handleReactionSelect(optionBtn) {
      if (isProcessing) return;
      isProcessing = true;
      
      const type = optionBtn.dataset.type;
      const post = optionBtn.closest('.post');
      const postId = post.dataset.postId;
      const wrapper = optionBtn.closest('.reaction-wrapper');
      const mainBtn = wrapper.querySelector('.main-reaction-btn');
      const picker = wrapper.querySelector('.reaction-picker');
      
      // Animation feedback
      optionBtn.style.transform = 'scale(1.4)';
      setTimeout(() => optionBtn.style.transform = '', 150);
      
      try {
        let response;
        
        if (type === "like") {
          response = await fetch(`${API_BASE}/posts/${postId}/like/`, {
            method: "POST",
            headers: authHeaders
          });
        } else {
          response = await fetch(`${API_BASE}/posts/${postId}/react/`, {
            method: "POST",
            headers: authHeaders,
            body: JSON.stringify({ reaction_type: type })
          });
        }

        if (!response.ok) throw new Error('Failed to react');
        
        const data = await response.json();
        console.log('Reaction response:', data);
        
        // Update button UI
        const reaction = REACTIONS.find(r => r.type === type);
        if (data.message.includes('removed') || data.message.includes('unliked')) {
          mainBtn.textContent = 'ðŸ˜Š React';
          mainBtn.classList.remove('reacted');
        } else {
          mainBtn.textContent = `${reaction.emoji} ${reaction.label}`;
          mainBtn.classList.add('reacted');
        }
        
        // Close picker
        picker.classList.remove('show');
        
      } catch (err) {
        console.error('Reaction error:', err);
        alert("Gagal mengirim reaksi. Coba lagi.");
      } finally {
        isProcessing = false;
      }
    }

    function renderSuggestions(sugg){
      joinLoad.style.display = "none";
      if(!sugg.length){
        joinList.innerHTML = `<p style="color:#666">Tidak ada saran komunitas.</p>`;
        return;
      }
      joinList.innerHTML = sugg.slice(0,5).map(c=>`
        <div class="c-item">
          <div class="c-info">
            <img class="c-avatar" src="${toAbs(c.profile_pic) || 'https://via.placeholder.com/90?text=%20'}" alt="">
            <div>
              <div class="c-name">${c.name||''}</div>
              <div class="c-members">${(c.member_count ?? c.members?.length) || 0} members</div>
            </div>
          </div>
          <button class="btn-join" data-id="${c.id}">Join</button>
        </div>
      `).join("");
      joinMore.style.display = "block";

      box.onclick = async (e) => {
        const btn = e.target.closest(".join-btn"); if (!btn) return;
        btn.disabled = true;
        try{
          await fetch(`${API_BASE}/communities/${btn.dataset.id}/join/`, { method:"POST", headers:authHeaders });
          btn.textContent = "Joined âœ“";
        }catch{
          btn.disabled = false;
          alert("Gagal join komunitas.");
        }
      };
    }
    
  </script>
</body>
</html>