<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CircleUP - Home</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:#f5f5f5;display:flex}

    /* Lebar sidebar (samakan dengan sidebar kamu) */
    :root { --sidebar-width: 260px; }

    /* Layout utama: jadikan grid 2 kolom fleksibel */
    .main-content {
    /* geser supaya tidak ketimpa sidebar */
    margin-left: var(--sidebar-width);

    /* grid dua kolom: konten (lebih lebar) + panel kanan */
    display: grid;
    grid-template-columns: minmax(720px, 1fr) 420px;
    gap: 24px;

    /* biar ‚Äúnyentuh‚Äù lebar layar */
    width: calc(100vw - var(--sidebar-width));
    max-width: 1600px;            /* kamu boleh ubah 1400‚Äì1800 */
    padding: 24px 24px 24px 24px; /* ruang kanan-kiri nyaman */
    overflow-y: auto;
    margin-right: auto;           /* ratakan konten ke kiri */
    }
    /* Feed sekarang tidak dibatasi max-width */
    .feed-container {
    max-width: none;
    width: 100%;
    padding: 0;                   /* padding dipindah ke main-content */
    }
    /* Story Slider */
    .story-slider{display:flex;gap:15px;overflow-x:auto;padding:20px 0;margin-bottom:20px}
    .story-slider::-webkit-scrollbar{display:none}
    .story-item{flex-shrink:0;width:130px;text-align:center;position:relative}
    .story-image{width:130px;height:100px;border-radius:12px;object-fit:cover}
    .story-title{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:13px;color:#fff;font-weight:500;background:rgba(0,0,0,.3);padding:5px 10px;border-radius:6px;width:calc(100% - 20px);text-align:center}

    /* Post Card */
    .post-card{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .post-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px}
    .post-user{display:flex;align-items:center;gap:12px}
    .post-avatar{width:45px;height:45px;border-radius:50%;object-fit:cover}
    .post-info h4{font-size:16px;color:#333;margin-bottom:2px}
    .post-time{font-size:13px;color:#888}
    .post-badge{display:flex;align-items:center;gap:5px;background:#fff3e0;padding:6px 12px;border-radius:20px;font-size:13px;color:#e59d2c;font-weight:500}
    .post-image{width:100%;border-radius:12px;margin-bottom:15px}
    .post-actions{display:flex;gap:10px;margin-bottom:12px}
    .reaction-btn{display:flex;align-items:center;gap:5px;padding:8px 15px;border:none;border-radius:20px;background:#f0f0f0;cursor:pointer;font-size:14px;transition:transform .2s}
    .reaction-btn:hover{transform:scale(1.05)}
    .reaction-btn.love{background:#ffeaa7}

    /* Panel rekomendasi lebih lebar, sticky di kanan */
    .right-sidebar {
    width: auto;
    max-width: 460px;             /* aman di layar besar; ubah kalau perlu */
    padding: 20px;
    background: #fff;
    margin: 0;                    /* hilangkan margin default */
    border-radius: 12px;
    height: fit-content;
    position: sticky;
    top: 16px;                    /* biar ngikut scroll */
    }
  </style>
</head>
<body>

  {% include "circleup/sidebar.html" %}

  <!-- Main Content -->
  <div class="main-content">
    <!-- Feed Container -->
    <div class="feed-container">
      <!-- Story dari backend -->
      <div class="story-slider" id="storySlider"></div>

      <!-- Feed posts dari backend -->
      <div id="postsWrap"></div>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
      <div class="join-communities" id="suggestionsWrap">
        <h3>Join Communities!</h3>
        <p style="color:#666">Loading suggestions‚Ä¶</p>
      </div>
    </div>
  </div>

  <!-- ===== Integrasi ke Backend ===== -->
  <script>
    // Ganti sekali kalau API kamu beda host:
    // localStorage.setItem("API_BASE","http://127.0.0.1:8000/api");
    const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api";

    // Wajib login: cek JWT di localStorage
    const ACCESS = localStorage.getItem("access");
    if (!ACCESS) { window.location.href = "/login/"; }

    const authHeaders = { Authorization: `Bearer ${ACCESS}`, "Content-Type": "application/json" };

    // Helper untuk normalisasi URL media (kalau API mengembalikan path relatif)
    const absUrl = (u) => {
      if (!u) return "";
      if (u.startsWith("http")) return u;
      const root = API_BASE.replace(/\/api\/?$/,"");
      return `${root}${u.startsWith("/") ? "" : "/"}${u}`;
    };

    // ---- Boot: ambil profil & home feed
    (async function init(){
      try{
        const [meR, homeR] = await Promise.all([
          fetch(`${API_BASE}/users/profile/`, { headers: authHeaders }),
          fetch(`${API_BASE}/home/`, { headers: authHeaders }),
        ]);
        if (!meR.ok) throw new Error("Token invalid. Silakan login ulang.");
        if (!homeR.ok) throw new Error("Gagal memuat feed.");

        const me = await meR.json();
        const home = await homeR.json(); // { joined_communities, posts, suggestions }


        renderStories(home.joined_communities || []);
        renderPosts(home.posts || []);
        renderSuggestions(home.suggestions || []);
      }catch(e){
        console.warn(e);
        localStorage.removeItem("access");
        localStorage.removeItem("refresh");
        localStorage.removeItem("currentUser");
        window.location.href="/login/";
      }
    })();

    // ---- Render Stories dari joined communities
    function renderStories(communities){
      const el = document.getElementById("storySlider");
      if (!el) return;
      if (!communities.length){ el.innerHTML=""; return; }
      el.innerHTML = communities.slice(0,10).map(c => `
        <div class="story-item">
          <img class="story-image" src="${absUrl(c.profile_pic) || 'https://via.placeholder.com/130x100?text=%20'}" alt="${c.name}"/>
          <div class="story-title">${c.name}</div>
        </div>
      `).join("");
    }

    // ---- Render Posts
    function renderPosts(posts){
      const wrap = document.getElementById("postsWrap");
      if (!wrap) return;
      if (!posts.length){
        wrap.innerHTML = `<p style="color:#666">Belum ada post dari komunitas yang kamu ikuti.</p>`;
        return;
      }

      wrap.innerHTML = posts.map(p => {
        const u = p.posted_by || p.user || {};
        const c = p.community || {};
        const t = p.created_at ? new Date(p.created_at).toLocaleString() : "";
        return `
          <div class="post-card">
            <div class="post-header">
              <div class="post-user">
                <img class="post-avatar" src="${absUrl(u.profile_pic) || 'https://via.placeholder.com/90?text=%20'}" alt="avatar"/>
                <div class="post-info">
                  <h4>${u.username || u.email || "User"}</h4>
                  <span class="post-time">${t}</span>
                </div>
              </div>
              <div class="post-badge">${c.name || "Community"}</div>
            </div>

            ${p.image ? `<img class="post-image" src="${absUrl(p.image)}" alt="post-image"/>` : ""}

            <div class="post-actions">
              <button class="reaction-btn love" data-id="${p.id}" data-type="love">‚ù§Ô∏è</button>
              <button class="reaction-btn like" data-id="${p.id}" data-type="like">üëç</button>
            </div>

            <div class="post-caption">
              <strong>${u.username || "User"}</strong> ${p.caption || ""}
            </div>
          </div>
        `;
      }).join("");

      // Handler like/react (delegation)
      wrap.onclick = async (e) => {
        const btn = e.target.closest("button.reaction-btn");
        if (!btn) return;
        const id = btn.dataset.id, type = btn.dataset.type;
        try{
          if (type === "like"){
            await fetch(`${API_BASE}/posts/${id}/like/`, { method:"POST", headers:authHeaders });
          }else{
            await fetch(`${API_BASE}/posts/${id}/react/`, {
              method:"POST", headers:authHeaders, body:JSON.stringify({ reaction_type:type })
            });
          }
          btn.style.transform="scale(1.08)"; setTimeout(()=>btn.style.transform="scale(1)",150);
        }catch{
          alert("Gagal mengirim reaksi. Coba lagi.");
        }
      };
    }

    // ---- Render Suggestions + Join
    function renderSuggestions(sugg){
      const box = document.getElementById("suggestionsWrap");
      if (!box) return;

      if (!sugg.length){
        box.innerHTML = `<h3>Join Communities!</h3><p style="color:#666">Tidak ada saran komunitas.</p>`;
        return;
      }

      box.innerHTML = `<h3>Join Communities!</h3>` + sugg.slice(0,5).map(c => `
        <div class="community-item">
          <div class="community-info">
            <img class="community-avatar" src="${absUrl(c.profile_pic) || 'https://via.placeholder.com/90?text=%20'}" alt="${c.name}"/>
            <div class="community-details">
              <h4>${c.name}</h4>
              <div class="community-members">${(c.member_count ?? c.members?.length) || 0} members</div>
            </div>
          </div>
          <button class="join-btn" data-id="${c.id}">Join</button>
        </div>
      `).join("") + `<div class="show-more">Show more</div>`;

      box.onclick = async (e) => {
        const btn = e.target.closest(".join-btn"); if (!btn) return;
        btn.disabled = true;
        try{
          await fetch(`${API_BASE}/communities/${btn.dataset.id}/join/`, { method:"POST", headers:authHeaders });
          btn.textContent = "Joined ‚úì";
        }catch{
          btn.disabled = false;
          alert("Gagal join komunitas.");
        }
      };
    }
  </script>
</body>
</html>
