{% load static %}

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CircleUP - Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:#f5f5f5;display:flex;overflow:hidden;color:#333}
    
    /* ===== COMMUNITY LIST SIDEBAR ===== */
    .community-list-sidebar {
      width: 400px;
      height: 100vh;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      position: fixed;
      left: 200px;
      top: 0;
      z-index: 999;
      display: flex;
      flex-direction: column;
    }

    .community-list-header {
      padding: 24px 20px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }

    .community-list-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .community-list-stats {
      font-size: 14px;
      color: #666;
    }

    .communities-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .communities-container::-webkit-scrollbar {
      width: 8px;
    }

    .communities-container::-webkit-scrollbar-thumb {
      background: #ddd;
      border-radius: 8px;
    }

    .community-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-radius: 12px;
      background: #fff;
      border: 2px solid #eee;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: inherit;
    }

    .community-card:hover {
      border-color: #e59d2c;
      background: #fef9f2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .community-card.active {
      border-color: #e59d2c;
      background: #fff3e0;
      border-left: 4px solid #e59d2c;
    }

    .community-card-avatar {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      background: #eaeaea;
      flex-shrink: 0;
    }

    .community-card-info {
      flex: 1;
      min-width: 0;
    }

    .community-card-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .community-card-members {
      font-size: 13px;
      color: #666;
    }

    /* Main container adjusted for community list sidebar */
    .main-container{
      display:flex;
      flex:1;
      height:100vh;
      overflow:hidden;
      margin-left:600px; /* 200px sidebar + 400px community list */
    }

    /* CHAT LAYOUT */
    .chat-container{
      flex:1;
      display:flex;
      flex-direction:column;
      background:#fff;
    }
    
    .chat-header{
      padding:16px 24px;
      background:#f5f5f5;
      border-bottom:1px solid #e0e0e0;
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink: 0;
    }
    
    .chat-title{font-size:18px;font-weight:600}
    .chat-stats{font-size:12px;color:#888}
    .chat-body{flex:1;display:flex;min-height:0;background:#fff}

    /* LEFT RAIL - Hide this as we now use community list sidebar */
    .left-rail{display:none}

    /* MESSAGES */
    .messages-wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    
    .chat-messages{
      flex:1;
      overflow-y:auto;
      padding:20px 30px;
      background:#fff;
    }
    
    .chat-messages::-webkit-scrollbar{
      width:10px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb{
      background:#ddd;
      border-radius:10px;
    }
    
    .message{margin-bottom:26px;position:relative}
    .message-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .message-avatar{width:38px;height:38px;border-radius:50%;object-fit:cover}
    .message-author{font-size:15px;font-weight:600}
    .message-time{font-size:12px;color:#888;margin-left:6px}
    .message-content{
      margin-left:50px;
      font-size:14px;
      line-height:1.5;
      color:#333;
      background:#f5f5f5;
      padding:12px 16px;
      border-radius:12px;
      display:inline-block;
      max-width:80%;
      word-wrap: break-word;
    }
    .message-image{
      margin-left:50px;
      margin-top:8px;
      max-width:560px;
      border-radius:12px;
      display:block;
    }
    .message-reactions{
      margin-left:50px;
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .reaction{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:4px 10px;
      background:#f5f5f5;
      border-radius:12px;
      font-size:13px;
      border:none;
      cursor:pointer;
      transition: all 0.2s;
    }
    .reaction.reacted{background:#fff3e0;border:1px solid #e59d2c}
    .reaction:hover{background:#e5e5e5}

    /* INPUT */
    .chat-input-container{
      padding:14px 20px;
      background:#fff;
      border-top:1px solid #e0e0e0;
      display:flex;
      align-items:center;
      gap:12px;
      flex-shrink: 0;
    }
    .chat-input{
      flex:1;
      padding:12px 16px;
      border:none;
      background:#f5f5f5;
      border-radius:25px;
      font-size:14px;
      outline:none;
    }
    .send-btn{
      width:42px;
      height:42px;
      border-radius:999px;
      border:none;
      background:#e59d2c;
      color:#fff;
      cursor:pointer;
      transition: background 0.2s;
    }
    .send-btn:hover{
      background:#d48b1f;
    }

    /* Responsive */
    @media (max-width:1400px){
      .main-container{margin-left:600px}
    }

    @media (max-width: 1024px){
      .community-list-sidebar{display:none}
      .main-container{margin-left:200px}
      .chat-messages{padding:16px}
    }

    @media (max-width: 768px){
      .main-container{margin-left:0}
    }
  </style>
</head>
<body>

{% include "circleup/sidebar.html" %}

<!-- COMMUNITY LIST SIDEBAR -->
<aside class="community-list-sidebar">
  <div class="community-list-header">
    <div class="community-list-title" id="currentCommunityName">Community</div>
    <div class="community-list-stats" id="currentCommunityStats">0 Members ¬∑ 0 Online</div>
  </div>
  
  <div class="communities-container" id="communitiesContainer">
    <div style="text-align:center;padding:40px;color:#888">Loading communities...</div>
  </div>
</aside>

<div class="main-container">
  <div class="chat-container">
    <div class="chat-header">
      <span class="chat-title" id="chatTitle">Chat</span>
      <span class="chat-stats" id="chatStats"></span>
    </div>
    <div class="chat-body">

      <!-- Left media rail (community thumbnails) - HIDDEN NOW -->
      <aside class="left-rail" id="leftRail">
        <div id="currentCommunityNameOld"></div>
      </aside>

      <!-- Messages -->
      <div class="messages-wrap">
        <div class="chat-messages" id="chatMessages">
          <!-- messages injected by JS -->
        </div>

        <!-- Input -->
        <div class="chat-input-container">
          <input type="text" class="chat-input" placeholder="Type your message" id="messageInput">
          <button class="send-btn" id="sendBtn" title="Send">‚û§</button>
        </div>

      </div>
    </div>
  </div>

  {% include "circleup/right-sidebar.html" %}
</div>

<script>
  // ===== Config & Auth guard =====
  const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api";
  const ACCESS = localStorage.getItem("access");
  if (!ACCESS) { window.location.href = "/login/"; }
  const H = { Authorization: `Bearer ${ACCESS}`, "Content-Type": "application/json" };

  const params = new URLSearchParams(location.search);
  let channelId = params.get("channel") || params.get("channel_id");
  let CHANNELSCACHE = [];
  let COMMUNITIESCACHE = [];
  let SELECTEDCOMMUNITYID = null;

  const REACT_MAP = {
    "üëç":"like","‚ù§Ô∏è":"love","üòÇ":"laugh","üòÆ":"wow","üò¢":"sad","üî•":"fire","üëè":"clap"
  };

  const absUrl = (u) => {
    if (!u) return "";
    if (typeof u === 'object' && u !== null) u = u.url || u.path || '';
    if (!u) return "";
    if (u.startsWith("http")) return u;
    const root = API_BASE.replace(/\/api\/?$/, "");
    return `${root}${u.startsWith("/") ? "" : "/"}${u}`;
  };

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g,(m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    })[m]);
  }

  // ===== Fetchers =====
  async function fetchJoinedCommunities(){
    const r = await fetch(`${API_BASE}/communities/joined/`, { headers: H });
    if (!r.ok) throw new Error("Gagal memuat communities");
    const communities = await r.json();
    COMMUNITIESCACHE = Array.isArray(communities) ? communities : [];
    return COMMUNITIESCACHE;
  }

  async function fetchChannels(){
    const r = await fetch(`${API_BASE}/channels/`, { headers: H });
    if (!r.ok) throw new Error("Gagal memuat channel");
    const data = await r.json();
    CHANNELSCACHE = Array.isArray(data) ? data : (data.results || []);
    return CHANNELSCACHE;
  }

  async function fetchMessages(){
    if (!channelId) return [];
    const r = await fetch(`${API_BASE}/chat-messages/?channel_id=${encodeURIComponent(channelId)}`, { headers: H });
    if (!r.ok) throw new Error("Gagal memuat pesan");
    const data = await r.json();
    return Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
  }

  // ===== Community List Sidebar =====
  function renderCommunityList(){
    const container = document.getElementById('communitiesContainer');
    if(!container) return;

    if(!COMMUNITIESCACHE.length){
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#888">No communities joined yet</div>';
      return;
    }

    container.innerHTML = COMMUNITIESCACHE.map(comm => {
      const isActive = String(comm.id) === String(SELECTEDCOMMUNITYID);
      const thumb = absUrl(comm.profile_pic || comm.profilepic || comm.background_banner || comm.backgroundpic) || 'https://via.placeholder.com/60?text=C';
      
      return `
        <div class="community-card ${isActive ? 'active' : ''}"
             onclick="selectCommunityFromList('${comm.id}')"
             data-community-id="${comm.id}">
          <img src="${escapeHtml(thumb)}" 
               alt="${escapeHtml(comm.name)}" 
               class="community-card-avatar"
               onerror="this.src='https://via.placeholder.com/60?text=C'">
          <div class="community-card-info">
            <div class="community-card-name">${escapeHtml(comm.name || 'Unnamed Community')}</div>
            <div class="community-card-members">${comm.member_count || comm.membercount || 0} members</div>
          </div>
        </div>
      `;
    }).join('');

    // Update header
    updateCommunityListHeader();
  }

  function updateCommunityListHeader(){
    const currentComm = COMMUNITIESCACHE.find(c => String(c.id) === String(SELECTEDCOMMUNITYID));
    const titleEl = document.getElementById('currentCommunityName');
    const statsEl = document.getElementById('currentCommunityStats');
    
    if(currentComm){
      if(titleEl) titleEl.textContent = currentComm.name || 'Community';
      if(statsEl) statsEl.textContent = 
        `${currentComm.member_count || currentComm.membercount || 0} Members ¬∑ ${currentComm.online_count || currentComm.onlinecount || 0} Online`;
    } else {
      if(titleEl) titleEl.textContent = 'Community';
      if(statsEl) statsEl.textContent = '0 Members ¬∑ 0 Online';
    }
  }

  // Select community from list
  window.selectCommunityFromList = function(commId){
    if (!commId) return;
    SELECTEDCOMMUNITYID = commId;
    
    // Find the correct general channel for this specific community
    const general = (CHANNELSCACHE || []).find(c => 
      String(c.community) === String(commId) && 
      (c.name || '').toLowerCase() === 'general'
    );
    
    if (general) {
      channelId = general.id;
      try {
        const url = new URL(location.href);
        url.searchParams.set('channel', channelId);
        history.replaceState(null, '', url);
      } catch(e){}
      syncRightSidebarFromCommunity(SELECTEDCOMMUNITYID);
      renderRightSidebarChannels(SELECTEDCOMMUNITYID);
      renderCommunityList();
      updateChatHeader();
      loadMessages();
    } else {
      // No general channel exists yet
      channelId = null;
      syncRightSidebarFromCommunity(SELECTEDCOMMUNITYID);
      renderRightSidebarChannels(SELECTEDCOMMUNITYID);
      renderCommunityList();
      updateChatHeader();
      const wrap = document.getElementById('chatMessages');
      if (wrap) wrap.innerHTML = `
        <div style="height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#777;text-align:center;padding:24px;">
          <div style="font-size:16px;margin-bottom:6px;">No messages yet</div>
          <div style="font-size:14px;">Let's start our conversation.</div>
        </div>`;
    }
  };

  // ===== Chat actions =====
  async function sendMessage(){
    const input = document.getElementById("messageInput");
    const text = (input?.value || "").trim();
    if (!text) return;

    // Ensure we're sending to the correct community's general channel
    if (!channelId && SELECTEDCOMMUNITYID) {
      const general = (CHANNELSCACHE || []).find(
        c => String(c.community) === String(SELECTEDCOMMUNITYID) && (c.name || '').toLowerCase() === 'general'
      );
      if (general) channelId = general.id;
    }

    // Validate that the channel belongs to the selected community
    const selectedChannel = CHANNELSCACHE.find(c => String(c.id) === String(channelId));
    if (!selectedChannel || String(selectedChannel.community) !== String(SELECTEDCOMMUNITYID)) {
      alert("Invalid channel for this community. Please select a valid channel.");
      return;
    }

    const r = await fetch(`${API_BASE}/chat-messages/`, {
      method: "POST",
      headers: H,
      body: JSON.stringify({ channel: channelId, message: text })
    });

    if (r.status === 401) {
      alert("Sesi kamu habis. Silakan login lagi.");
      localStorage.removeItem("access");
      window.location.href = "/login/";
      return;
    }

    if (!r.ok) {
      const data = await r.json().catch(() => null);
      alert("Gagal mengirim pesan: " + (JSON.stringify(data) || r.status));
      return;
    }

    if (input) input.value = "";
    await loadMessages();
  }

  async function reactMessage(id, emoji){
    const type = REACT_MAP[emoji] || "like";
    await fetch(`${API_BASE}/chat-messages/${id}/react/`, {
      method: "POST",
      headers: H,
      body: JSON.stringify({ reaction_type: type })
    }).catch(()=>{});
    loadMessages();
  }

  // ===== Render chat =====
  function render(messages){
    const wrap = document.getElementById("chatMessages");
    const list = Array.isArray(messages) ? messages : (messages?.results || []);

    if (!Array.isArray(list) || !list.length){
      if (wrap) wrap.innerHTML = `
        <div style="height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#777;text-align:center;padding:24px;">
          <div style="font-size:16px;margin-bottom:6px;">No messages yet</div>
          <div style="font-size:14px;">Let's start our conversation.</div>
        </div>
      `;
      const stats = document.getElementById("chatStats");
      if (stats) stats.textContent = "";
      return;
    }

    const ch = list?.channel || {};
    const titleEl = document.getElementById("chatTitle");
    if (titleEl) titleEl.textContent = ch.name || "Chat";
    const memberCount = ch.member_count ?? ch.members?.length;
    const stats = document.getElementById("chatStats");
    if (stats) stats.textContent = memberCount ? `- ${memberCount} members` : "";

    if (wrap){
      wrap.innerHTML = list.map(m => {
        const u = m.user || m.sender || {};
        const avatar = absUrl(u.profilepic || u.profile_pic) || 'https://via.placeholder.com/80?text=%20';
        const when = m.created_at ? new Date(m.created_at).toLocaleString() : "";
        const reacts = (m.reactions || []).map(r => {
          const label = Object.keys(REACT_MAP).find(k => REACT_MAP[k] === r.reaction_type) || "üëç";
          return `<span class="reaction">${label} ${r.count || 1}</span>`;
        }).join("");
        return `
          <div class="message">
            <div class="message-header">
              <img class="message-avatar" src="${escapeHtml(avatar)}" alt="${escapeHtml(u.username || u.email || 'User')}" />
              <span class="message-author">${escapeHtml(u.username || u.email || 'User')}</span>
              <span class="message-time">${escapeHtml(when)}</span>
            </div>
            ${m.message ? `<div class="message-content">${escapeHtml(m.message)}</div>` : ""}
            ${m.image ? `<img class="message-image" src="${escapeHtml(absUrl(m.image))}" alt="attachment"/>` : ""}
            <div class="message-reactions">
              <button class="reaction" onclick="reactMessage('${m.id}','‚ù§Ô∏è')">‚ù§Ô∏è</button>
              <button class="reaction" onclick="reactMessage('${m.id}','üëç')">üëç</button>
              <button class="reaction" onclick="reactMessage('${m.id}','üòÇ')">üòÇ</button>
            </div>
          </div>
        `;
      }).join("");
    }
  }

  function communityInfo(commId){
    if (!commId) return null;
    return (COMMUNITIESCACHE || []).find(x => String(x.id) === String(commId)) || null;
  }

  function channelInfo(cid){
    if (!cid) return null;
    return (CHANNELSCACHE || []).find(x => String(x.id) === String(cid)) || null;
  }

  // Update chat header to show community name
  function updateChatHeader() {
    const titleEl = document.querySelector('.chat-title');
    if (!titleEl) return;
    const comm = communityInfo(SELECTEDCOMMUNITYID);
    
    // Show community name in header
    if (comm) {
      titleEl.textContent = comm.name;
    } else {
      titleEl.textContent = 'Chat';
    }
  }

  // ===== Right sidebar =====
  function syncRightSidebarFromCommunity(commId){
    const c = communityInfo(commId);
    const imgEl = document.querySelector('[data-rs="image"]');
    const nameEl = document.querySelector('[data-rs="name"]');
    const countEl = document.querySelector('[data-rs="counts"]');
    if (!c) return;
    if (imgEl) imgEl.src = absUrl(c.backgroundpic || c.background_banner) || absUrl(c.profilepic || c.profile_pic) || 'https://via.placeholder.com/300x120';
    if (nameEl) nameEl.textContent = c.name || "";
    if (countEl) countEl.textContent = `${c.membercount || c.member_count || 0} Members, ${c.onlinecount || c.online_count || 0} Online`;
  }

  // Always show General even if empty and route composer to it
  function renderRightSidebarChannels(commId){
    const box = document.getElementById("channels-list");
    if (!box) return;

    const all = (CHANNELSCACHE || []).filter(c => String(c.community) === String(commId));
    const hasGeneral = all.some(c => (c.name || '').toLowerCase() === 'general');
    let display = [...all];
    if (!hasGeneral) {
      display.unshift({ id: null, community: commId, name: 'General', _virtual: true });
    }

    box.innerHTML = display.map(c => `
      <a href="${c.id ? `?channel=${c.id}` : '#'}" class="channel-item ${String(c.id) === String(channelId) ? 'active' : ''}" data-channel="${c.id || ''}" data-comm="${commId}" data-virtual="${c._virtual ? 1 : 0}">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
        <span>${escapeHtml(c.name)}</span>
      </a>
    `).join("");

    box.querySelectorAll(".channel-item").forEach(a => {
      a.addEventListener("click", async (e) => {
        e.preventDefault();
        const isVirtual = a.getAttribute('data-virtual') === '1';
        const comm = a.getAttribute('data-comm');
        
        if (isVirtual) {
          // Resolve General channel id if it exists now
          let gen = (CHANNELSCACHE || []).find(c => String(c.community) === String(comm) && (c.name || '').toLowerCase() === 'general');
          if (!gen) {
            await fetchChannels();
            gen = (CHANNELSCACHE || []).find(c => String(c.community) === String(comm) && (c.name || '').toLowerCase() === 'general');
          }
          channelId = gen ? gen.id : null;
        } else {
          channelId = a.getAttribute("data-channel");
        }

        SELECTEDCOMMUNITYID = comm;
        try {
          if (channelId) {
            const url = new URL(location.href);
            url.searchParams.set("channel", channelId);
            history.replaceState(null, "", url);
          }
        } catch(e){}

        box.querySelectorAll(".channel-item").forEach(x => x.classList.remove("active"));
        if (channelId) a.classList.add("active");
        renderCommunityList();
        updateChatHeader();
        if (channelId) {
          loadMessages();
        } else {
          const wrap = document.getElementById('chatMessages');
          if (wrap) wrap.innerHTML = `
            <div style="height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#777;text-align:center;padding:24px;">
              <div style="font-size:16px;margin-bottom:6px;">No messages yet</div>
              <div style="font-size:14px;">Let's start our conversation.</div>
            </div>`;
        }
      });
    });
  }

  // ===== Boot & events =====
  async function loadMessages(){
    try{
      const data = await fetchMessages();
      const list = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
      if (!Array.isArray(list) || list.length === 0){
        const wrap = document.getElementById("chatMessages");
        if (wrap) {
          wrap.innerHTML = `
            <div style="height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#777;text-align:center;padding:24px;">
              <div style="font-size:16px;margin-bottom:6px;">No messages yet</div>
              <div style="font-size:14px;">Let's start our conversation.</div>
            </div>
          `;
        }
        updateChatHeader();
        return;
      }

      render(list);
      updateChatHeader();
      const cm = document.getElementById("chatMessages");
      if (cm) cm.scrollTop = cm.scrollHeight;
    } catch(e){
      console.warn(e);
      const wrap = document.getElementById("chatMessages");
      if (wrap) wrap.innerHTML = `<p style="color:#b00020">Gagal memuat chat.</p>`;
    }
  }

  const sendBtn = document.getElementById("sendBtn");
  if (sendBtn) sendBtn.addEventListener("click", (e) => { e.preventDefault(); sendMessage(); });
  const msgInput = document.getElementById("messageInput");
  if (msgInput) msgInput.addEventListener("keypress", (e) => { if(e.key === "Enter"){ e.preventDefault(); sendMessage(); } });

  async function boot(){
    try{
      await Promise.all([fetchJoinedCommunities(), fetchChannels()]);
      
      // Initialize selected community from channel if available
      if (channelId) {
        const ch = (CHANNELSCACHE || []).find(c => String(c.id) === String(channelId));
        if (ch) {
          SELECTEDCOMMUNITYID = ch.community;
        }
      }
      
      // If no community selected, pick first one
      if (!SELECTEDCOMMUNITYID && COMMUNITIESCACHE.length > 0){
        SELECTEDCOMMUNITYID = COMMUNITIESCACHE[0].id;
      }

      renderCommunityList();
      if (SELECTEDCOMMUNITYID) {
        syncRightSidebarFromCommunity(SELECTEDCOMMUNITYID);
        renderRightSidebarChannels(SELECTEDCOMMUNITYID);
      }

      // Only auto-select general if no channel is specified
      if (!channelId && SELECTEDCOMMUNITYID){
        const general = (CHANNELSCACHE || []).find(c => 
          String(c.community) === String(SELECTEDCOMMUNITYID) && 
          (c.name || '').toLowerCase() === 'general'
        );
        if (general) channelId = general.id;
      }

      if (channelId) await loadMessages();
      updateChatHeader();
    } catch(e){
      console.warn(e);
      const container = document.getElementById('communitiesContainer');
      if (container) container.innerHTML = `<div style="color:#b00020;padding:20px;text-align:center">Gagal memuat data</div>`;
    }
  }

  boot();

  setInterval(() => { if (channelId) loadMessages(); }, 8000);
</script>

</body>
</html>
