{% load static %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  .sidebar {
    width: 200px; height: 100vh; background:#e8e8e8;
    display:flex; flex-direction:column; padding:30px 0; position:fixed;
    font-family: 'Poppins', sans-serif;
  }
  
  .logo { font-size:32px; font-weight:bolder; font-style: italic; color:#333; padding:0 25px; margin-bottom:30px; }
  .menu { flex:1; display:flex; flex-direction:column; }
  .menu-item {
    display:flex; align-items:center; padding:15px 25px; color:#555; text-decoration:none;
    font-size:15px; font-weight:400; transition:.3s ease; cursor:pointer; border:none; background:none; width:100%; text-align:left;
  }
  .menu-item svg { width:28px; height:28px; margin-right:20px; fill:#555; transition:fill .3s ease; }
  .menu-item:hover { background:rgba(255,152,0,.1); }
  .menu-item.active { background:#e59d2c; color:#fff; font-weight:600; }
  .menu-item.active svg { fill:#fff; }
  .dropdown { position:relative; }
  .dropdown-menu {
    position:absolute; left:100%; top:0; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.15);
    border-radius:8px; min-width:200px; opacity:0; visibility:hidden; transform:translateX(-10px);
    transition:.3s ease; z-index:100; overflow:hidden;
  }
  .dropdown-menu.show { opacity:1; visibility:visible; transform:translateX(10px); }
  .dropdown-item { 
    display:block; padding:15px 20px; color:#333; text-decoration:none; 
    font-size:16px; background:none; border:none; width:100%; text-align:left; 
    cursor:pointer; transition: background-color 0.2s;
  }
  .dropdown-item:hover { background:#f5f5f5; }
  .profile-section { padding:0 25px; margin-top:auto; }
  .profile { 
    display:flex; align-items:center; padding:15px 0; color:#555; 
    text-decoration:none; font-size:15px; cursor:pointer; transition: opacity 0.2s;
  }
  .profile:hover { opacity: 0.7; }
  .profile-icon { 
    width:40px; height:40px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
    border-radius:50%; margin-right:15px; display:flex; align-items:center; justify-content:center;
    overflow: hidden; position: relative;
  }
  .profile-icon svg { width:24px; height:24px; fill:#fff; z-index: 1; }
  .profile-icon img {
    width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 2;
  }
</style>

{% with current=request.resolver_match.url_name %}
<aside class="sidebar">
  <div class="logo">CircleUP</div>

  <nav class="menu">
    <!-- HOME -->
    <a href="{% url 'home' %}"
       class="menu-item {% if current == 'home' %}active{% endif %}"
       data-page="home">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      Home
    </a>

    <!-- EXPLORE -->
    <a href="{% url 'explore' %}"
       class="menu-item {% if current == 'explore' %}active{% endif %}"
       data-page="explore">
      <svg viewBox="0 0 24 24"><path d="M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z"/></svg>
      Explore
    </a>

    <!-- COMMUNITY (CHAT) -->
    <a href="{% url 'chat' %}"
       class="menu-item {% if current == 'chat' %}active{% endif %}"
       data-page="community">
      <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
      Community
    </a>

    <!-- NOTIFICATIONS -->
    <a href="{% url 'notifications' %}" 
       class="menu-item {% if current == 'notifications' %}active{% endif %}"
       data-page="notifications">
      <svg viewBox="0 0 24 24">
        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
      </svg>
      Notifications
    </a>

    <!-- MORE DROPDOWN -->
    <div class="dropdown">
      <button class="menu-item" id="moreBtn">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        More
      </button>
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="/reset-password/" class="dropdown-item">Change Password</a>
        <button class="dropdown-item" onclick="handleLogout()">Log Out</button>
      </div>
    </div>
  </nav>

  <!-- PROFILE SECTION -->
  <div class="profile-section">
    <a href="{% url 'profile' %}" class="profile">
      <div class="profile-icon" id="sidebarProfileIcon">
        <svg viewBox="0 0 24 24">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
      </div>
      <span id="sidebarProfileName">Profile</span>
    </a>
  </div>

</aside>
{% endwith %}

<script>
  // Dropdown toggle
  (function() {
    const moreBtn = document.getElementById('moreBtn');
    const dropdownMenu = document.getElementById('dropdownMenu');
    if (!moreBtn || !dropdownMenu) return;
    
    moreBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      dropdownMenu.classList.toggle('show');
      this.classList.toggle('active');
    });
    
    document.addEventListener('click', function(e) {
      if (!moreBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.remove('show');
        moreBtn.classList.remove('active');
      }
    });
  })();

  // Load user profile for sidebar
  async function loadSidebarProfile() {
    const token = localStorage.getItem('access');
    if (!token) return;

    // Try to load from cache first
    const cachedProfile = localStorage.getItem('sidebarProfile');
    if (cachedProfile) {
      try {
        const user = JSON.parse(cachedProfile);
        updateSidebarProfile(user);
      } catch (e) {
        console.error('Error parsing cached profile:', e);
      }
    }

    // Then fetch fresh data in background
    try {
      const response = await fetch('http://127.0.0.1:8000/api/users/profile/', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        const user = await response.json();
        // Save to cache
        localStorage.setItem('sidebarProfile', JSON.stringify(user));
        updateSidebarProfile(user);
      }
    } catch (error) {
      console.error('Error loading sidebar profile:', error);
    }
  }

  // Update sidebar profile display
  function updateSidebarProfile(user) {
    const profileIcon = document.getElementById('sidebarProfileIcon');
    const profileName = document.getElementById('sidebarProfileName');
    
    if (!profileIcon || !profileName) return;

    // Update name
    profileName.textContent = user.first_name || 'Profile';

    // Update profile picture
    let profilePicUrl = null;
    if (user.profile_pic) {
      profilePicUrl = user.profile_pic.startsWith('http') 
        ? user.profile_pic 
        : `http://127.0.0.1:8000${user.profile_pic}`;
    } else {
      profilePicUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.first_name + ' ' + user.last_name)}&size=80&background=667eea&color=fff`;
    }

    // Remove existing image if any
    const existingImg = profileIcon.querySelector('img');
    if (existingImg) {
      existingImg.remove();
    }

    // Add new image
    const img = document.createElement('img');
    img.src = profilePicUrl;
    img.alt = 'Profile';
    img.onerror = function() {
      this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.first_name + ' ' + user.last_name)}&size=80&background=667eea&color=fff`;
    };
    profileIcon.appendChild(img);

    // Hide the SVG icon when image is loaded
    const svg = profileIcon.querySelector('svg');
    if (svg) {
      svg.style.display = 'none';
    }
  }

  // Expose function globally so profile page can call it
  window.updateSidebarProfile = updateSidebarProfile;

  // Also update cache when profile is updated
  window.updateSidebarProfileCache = function(user) {
    localStorage.setItem('sidebarProfile', JSON.stringify(user));
    updateSidebarProfile(user);
  };

  // Load profile when page loads
  (function() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadSidebarProfile);
    } else {
      loadSidebarProfile();
    }
  })();

  // Handle logout
  async function handleLogout() {
    if (!confirm('Are you sure you want to log out?')) {
      return;
    }

    try {
      const refreshToken = localStorage.getItem('refresh');
      const accessToken = localStorage.getItem('access');
      
      if (refreshToken && accessToken) {
        try {
          await fetch('http://127.0.0.1:8000/api/auth/jwt/blacklist/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              refresh: refreshToken
            })
          });
        } catch (apiError) {
          console.warn('API blacklist call failed:', apiError);
        }
      }

      localStorage.removeItem('access');
      localStorage.removeItem('refresh');
      localStorage.removeItem('currentUser');
      localStorage.removeItem('API_BASE');
      localStorage.removeItem('sidebarProfile'); // Clear sidebar cache
      
      window.location.href = "/login/";
      
    } catch (error) {
      console.error('Logout error:', error);
      localStorage.removeItem('access');
      localStorage.removeItem('refresh');
      localStorage.removeItem('currentUser');
      localStorage.removeItem('API_BASE');
      localStorage.removeItem('sidebarProfile'); // Clear sidebar cache
      window.location.href = "/login/";
    }
  }
</script>