<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>CircleUP - Explore</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:#f5f5f5}
    .container{display:flex;min-height:100vh}

    /* Main */
    :root{--sidebar-width:260px}
    .main-content{
      margin-left:var(--sidebar-width);
      flex:1;overflow-y:auto;
    }

    /* Hero */
    .hero{background:linear-gradient(135deg,#c99746 0%,#b8863d 100%);padding:60px 40px;text-align:center;position:relative;overflow:hidden}
    .hero h1{color:#fff;font-size:42px;font-weight:700;margin-bottom:16px}
    .hero p{color:#fff;font-size:16px;max-width:650px;margin:0 auto 20px;line-height:1.6}
    .hero-buttons{display:flex;gap:12px;justify-content:center}
    .btn{padding:12px 22px;border:none;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer}
    .btn-light{background:#fff;color:#333}.btn-light:hover{background:#f0f0f0}
    .btn-dark{background:#3a3a3a;color:#fff}.btn-dark:hover{background:#2a2a2a}

    /* Search */
    .search-section{padding:28px 40px;max-width:1200px;margin:0 auto}
    .search-bar{display:flex;gap:10px;margin-bottom:24px}
    .search-input{flex:1;padding:14px 16px;border:none;background:#e8e8e8;border-radius:8px;font-size:15px;color:#444}
    .search-btn{padding:14px 18px;background:#c99746;border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:16px}
    .search-btn:hover{background:#b8863d}

    /* Grid */
    .communities-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px}
    .community-card{position:relative;border-radius:12px;overflow:hidden;height:260px;background:#ddd}
    .community-card img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
    .community-card:hover img{transform:scale(1.05)}
    .community-overlay{position:absolute;left:0;right:0;bottom:0;padding:20px;background:linear-gradient(to top,rgba(0,0,0,.8),rgba(0,0,0,.35) 60%,transparent)}
    .community-name{color:#fff;font-size:20px;font-weight:700;margin-bottom:6px}
    .community-members{color:rgba(255,255,255,.9);font-size:13px;margin-bottom:10px}
    .join-btn{background:#fff;color:#333;border:none;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer}
    .empty{color:#666;padding:8px 2px}
    @media(max-width:1024px){.main-content{margin-left:var(--sidebar-width)}}
  </style>
</head>
<body>
<div class="container">
  {% include 'circleup/sidebar.html' %}
  <div class="main-content">
    <!-- Hero -->
    <section class="hero">
      <h1>FIND YOUR COMMUNITY</h1>
      <p>Looking for a place to belong? Explore recommendations or search communities that fit you.</p>
      <div class="hero-buttons">
        <button class="btn btn-light" id="joinWithLinkBtn">Join with Link</button>
        <button class="btn btn-dark" id="startNewBtn">Start New Community</button>
      </div>
    </section>

    <!-- Search + Grid -->
    <section class="search-section">
      <form class="search-bar" id="searchForm">
        <input type="text" class="search-input" id="q" placeholder="Explore communities"/>
        <button class="search-btn" type="submit">üîç</button>
      </form>

      <div id="resultTitle" class="empty">Recommendations</div>
      <div class="communities-grid" id="grid">
        <!-- cards injected by JS -->
      </div>
    </section>
  </div>
</div>

<script>
  // ======= Config & Auth guard =======
  const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api";
  const ACCESS = localStorage.getItem("access");
  if (!ACCESS) { window.location.href = "/login/"; }
  const H = { Authorization: `Bearer ${ACCESS}`, "Content-Type":"application/json" };

  // normalize media/relative url
  const absUrl = (u) => {
    if (!u) return "";
    if (u.startsWith("http")) return u;
    const root = API_BASE.replace(/\/api\/?$/,"");
    return `${root}${u.startsWith("/") ? "" : "/"}${u}`;
  };

  const grid = document.getElementById("grid");
  const resultTitle = document.getElementById("resultTitle");
  const searchForm = document.getElementById("searchForm");
  const qInput = document.getElementById("q");

  // ======= Fetchers =======
  async function fetchExplore(){
    const r = await fetch(`${API_BASE}/communities/explore/`, { headers: H });
    if (!r.ok) throw new Error("Failed to load recommendations");
    return r.json();
  }
  async function fetchSearch(q){
    const r = await fetch(`${API_BASE}/communities/search/?q=${encodeURIComponent(q)}`, { headers: H });
    if (!r.ok) throw new Error("Failed to search");
    return r.json();
  }
  async function joinCommunity(id, btn){
    btn.disabled = true;
    try{
      const r = await fetch(`${API_BASE}/communities/${id}/join/`, { method:"POST", headers:H });
      if (!r.ok) throw new Error("Join failed");
      btn.textContent = "Joined ‚úì";
    }catch(e){
      btn.disabled = false;
      alert("Gagal join komunitas.");
    }
  }

  // ======= Renderers =======
  function renderCommunities(items){
    if (!Array.isArray(items) || !items.length){
      grid.innerHTML = `<p class="empty">Tidak ada komunitas.</p>`;
      return;
    }
    grid.innerHTML = items.map(c => `
      <div class="community-card">
        <img src="${absUrl(c.profile_pic) || 'https://via.placeholder.com/600x400?text=%20'}" alt="${c.name}"/>
        <div class="community-overlay">
          <div class="community-name">${c.name}</div>
          <div class="community-members">${(c.member_count ?? c.members?.length) || 0} Members</div>
          <button class="join-btn" data-id="${c.id}">Join</button>
        </div>
      </div>
    `).join("");
  }

  // Delegated click for join
  grid.addEventListener("click", (e) => {
    const btn = e.target.closest(".join-btn");
    if (!btn) return;
    joinCommunity(btn.dataset.id, btn);
  });

  // Search handler
  searchForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const q = qInput.value.trim();
    resultTitle.textContent = q ? `Search: "${q}"` : "Recommendations";
    grid.innerHTML = `<p class="empty">Loading...</p>`;
    try{
      const data = q ? await fetchSearch(q) : await fetchExplore();
      renderCommunities(data || []);
    }catch(err){
      grid.innerHTML = `<p class="empty">Gagal memuat data.</p>`;
      console.warn(err);
    }
  });

  // ======= Boot: load recommendations =======
  (async function init(){
    grid.innerHTML = `<p class="empty">Loading...</p>`;
    try{
      const data = await fetchExplore();
      renderCommunities(data || []);
    }catch(err){
      grid.innerHTML = `<p class="empty">Gagal memuat data.</p>`;
      console.warn(err);
    }
  })();
</script>
</body>
</html>
