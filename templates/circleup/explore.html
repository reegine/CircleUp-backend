<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>CircleUP - Explore</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:#f5f5f5}
    .container{display:flex;min-height:100vh}

    /* Main */
    :root{--sidebar-width:260px}
    .main-content{
      margin-left:200px;
      flex:1;overflow-y:auto;
    }

    /* Hero */
    .hero{background:linear-gradient(135deg,#c99746 0%,#b8863d 100%);padding:60px 40px;text-align:center;position:relative;overflow:hidden}
    .circles-pattern{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
    .circle{border:3px solid rgba(255,255,255,0.4);border-radius:50%;position:absolute}
    .circle:nth-child(1){top:10%;left:15%;width:120px;height:120px}
    .circle:nth-child(2){top:5%;left:35%;width:160px;height:160px}
    .circle:nth-child(3){top:8%;left:58%;width:140px;height:140px}
    .circle:nth-child(4){top:12%;right:10%;width:180px;height:180px}
    .circle:nth-child(5){top:35%;left:8%;width:150px;height:150px}
    .circle:nth-child(6){top:32%;left:28%;width:130px;height:130px}
    .hero h1{color:#fff;font-size:42px;font-weight:700;margin-bottom:16px;position:relative;z-index:1}
    .hero p{color:#fff;font-size:16px;max-width:650px;margin:0 auto 20px;line-height:1.6;position:relative;z-index:1}
    .hero-buttons{display:flex;gap:12px;justify-content:center;position:relative;z-index:1}
    .btn{padding:12px 22px;border:none;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer}
    .btn-light{background:#fff;color:#333}.btn-light:hover{background:#f0f0f0}
    .btn-dark{background:#3a3a3a;color:#fff}.btn-dark:hover{background:#2a2a2a}

    /* Search */
    .search-section{padding:28px 40px;max-width:1200px;margin:0 auto}
    .search-bar{display:flex;gap:10px;margin-bottom:24px}
    .search-input{flex:1;padding:14px 16px;border:none;background:#e8e8e8;border-radius:8px;font-size:15px;color:#444}
    .search-btn{padding:14px 18px;background:#c99746;border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:16px}
    .search-btn:hover{background:#b8863d}

    /* Grid */
    .communities-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
    .community-card{position:relative;border-radius:10px;overflow:hidden;height:260px;background:#ddd}
    .community-card img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
    .community-overlay{position:absolute;left:0;right:0;bottom:0;padding:20px;background:linear-gradient(to top,rgba(0,0,0,.8),rgba(0,0,0,.35) 60%,transparent);opacity:0;transition:opacity .3s ease}
    .community-card:hover .community-overlay{opacity:1}
    .community-name{color:#fff;font-size:20px;font-weight:700;margin-bottom:6px}
    .community-members{color:rgba(255,255,255,.9);font-size:13px;margin-bottom:10px}
    .join-btn{background:#fff;color:#333;border:none;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;transition:transform .2s}
    .join-btn:hover{transform:scale(1.05)}
    .empty{color:#666;padding:8px 2px}

    /* === Modal Styles (required) === */
    .modal-overlay{
      display:none;
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.5);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    .modal-overlay.active{display:flex}
    .modal{
      background:#fff;
      border-radius:12px;
      width:90%;
      max-width:540px;
      max-height:90vh;
      overflow:auto;
      position:relative;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:20px 24px;
      border-bottom:1px solid #e0e0e0;
    }
    .modal-title{font-size:20px;font-weight:600;color:#1a1a1a}
    .modal-close{
      background:none;border:none;font-size:24px;cursor:pointer;color:#666;
      width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;
    }
    .modal-close:hover{background:#f0f0f0}
    .modal-body{padding:24px}
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:15px;font-weight:600;color:#1a1a1a;margin-bottom:8px}
    .form-input{
      width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;
      font-family:'Poppins',sans-serif;background:#f8f8f8;
    }
    .form-input:focus{outline:none;border-color:#c99746;background:#fff}
    .form-textarea{
      width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;
      font-family:'Poppins',sans-serif;background:#f8f8f8;min-height:120px;resize:vertical;
    }
    .form-textarea:focus{outline:none;border-color:#c99746;background:#fff}
    .modal-btn{
      width:100%;padding:14px;background:#3a3a3a;color:#fff;border:none;border-radius:25px;
      font-size:15px;font-weight:600;cursor:pointer;margin-top:8px;
    }
    .modal-btn:hover{background:#2a2a2a}
    .save-btn{
      background:#3a3a3a;color:#fff;border:none;padding:10px 24px;border-radius:20px;font-size:14px;font-weight:600;cursor:pointer;
    }
    .save-btn:hover{background:#2a2a2a}

    /* Upload (opsional) */
    .image-upload-section{margin-bottom:24px}
    .image-upload-grid{display:flex;gap:12px;align-items:flex-start}
    .profile-upload,.banner-upload{
      position:relative;background:#f0f0f0;border-radius:8px;overflow:hidden;cursor:pointer;border:2px dashed #ccc;
    }
    .profile-upload{width:120px;height:120px;flex-shrink:0}
    .banner-upload{flex:1;height:180px}
    .upload-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#666}
    .upload-icon{font-size:32px;margin-bottom:8px}
    .upload-text{font-size:13px}
    .preview-image{width:100%;height:100%;object-fit:cover}
    .upload-input{display:none}

    @media(max-width:640px){
      .modal{width:95%;max-width:none}
      .image-upload-grid{flex-direction:column}
      .banner-upload{width:100%;height:160px}
    }

    @media(max-width:1024px){.main-content{margin-left:var(--sidebar-width)}}
  </style>
</head>
<body>
<div class="container">
  {% include 'circleup/sidebar.html' %}
  <div class="main-content">
    <!-- Hero -->
    <section class="hero">
      <div class="circles-pattern">
        <div class="circle"></div><div class="circle"></div><div class="circle"></div>
        <div class="circle"></div><div class="circle"></div><div class="circle"></div>
      </div>
      <h1>FIND YOUR COMMUNITY</h1>
      <p>Looking for a place to belong? Search for a community that fits you, join instantly with a link, or start your own community and bring people together on CircleUP.</p>
      <div class="hero-buttons">
        <!-- Tambahkan ID di sini -->
        <button class="btn btn-light" id="joinLinkBtn">Join with Link</button>
        <button class="btn btn-dark" id="startCommunityBtn">Start New Community</button>
      </div>
    </section>

    <!-- Search + Grid -->
    <section class="search-section">
      <form class="search-bar" id="searchForm">
        <input type="text" class="search-input" id="q" placeholder="Explore communities"/>
        <button class="search-btn" type="submit">üîç</button>
      </form>
      <div class="communities-grid" id="grid"></div>
    </section>
  </div>
</div>

<!-- Join with Link Modal -->
<div class="modal-overlay" id="joinLinkModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Join Community</h2>
      <button class="modal-close" id="closeJoinModal" aria-label="Close">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="joinLinkForm">
        <div class="form-group">
          <label class="form-label" for="inviteLink">Invite Link</label>
          <input id="inviteLink" type="url" class="form-input" placeholder="https://contoh.com/invite/abc" required />
        </div>
        <button type="submit" class="modal-btn">Join Community</button>
      </form>
    </div>
  </div>
</div>

<!-- Start New Community Modal -->
<div class="modal-overlay" id="startCommunityModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Start New Community</h2>
      <button class="modal-close" id="closeStartModal" aria-label="Close">‚úï</button>
      <button class="save-btn" id="saveCommunityBtn">Save</button>
    </div>
    <div class="modal-body">
      <form id="startCommunityForm">
        <div class="image-upload-section">
          <div class="image-upload-grid">
            <div class="profile-upload" id="profileUpload">
              <div class="upload-placeholder"><div class="upload-icon">üì∑</div></div>
              <input type="file" class="upload-input" id="profileInput" accept="image/*" />
            </div>
            <div class="banner-upload" id="bannerUpload">
              <div class="upload-placeholder"><div class="upload-icon">üì∑</div><div class="upload-text">Upload Banner</div></div>
              <input type="file" class="upload-input" id="bannerInput" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="communityName">Community Name</label>
          <input id="communityName" type="text" class="form-input" placeholder="Enter community name" required />
        </div>

        <div class="form-group">
          <label class="form-label" for="communityBio">Bio</label>
          <textarea id="communityBio" class="form-textarea" placeholder="Describe your community..."></textarea>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // ======= Config & Auth guard =======
  const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api";
  const ACCESS = localStorage.getItem("access");
  if (!ACCESS) { window.location.href = "/login/"; }
  const H = { Authorization: `Bearer ${ACCESS}`, "Content-Type":"application/json" };

  const absUrl = (u) => {
    if (!u) return "";
    if (u.startsWith("http")) return u;
    const root = API_BASE.replace(/\/api\/?$/,"");
    return `${root}${u.startsWith("/") ? "" : "/"}${u}`;
  };

  const grid = document.getElementById("grid");
  const searchForm = document.getElementById("searchForm");
  const qInput = document.getElementById("q");

  // ======= Fetchers =======
  async function fetchExplore(){
    const r = await fetch(`${API_BASE}/communities/explore/`, { headers: H });
    if (!r.ok) throw new Error("Failed to load recommendations");
    return r.json();
  }
  async function fetchSearch(q){
    const r = await fetch(`${API_BASE}/communities/search/?q=${encodeURIComponent(q)}`, { headers: H });
    if (!r.ok) throw new Error("Failed to search");
    return r.json();
  }
  async function joinCommunity(id, btn){
    btn.disabled = true;
    try{
      const r = await fetch(`${API_BASE}/communities/${id}/join/`, { method:"POST", headers:H });
      if (!r.ok) throw new Error("Join failed");
      btn.textContent = "Joined ‚úì";
    }catch(e){
      btn.disabled = false;
      alert("Gagal join komunitas.");
    }
  }

  // ======= Renderers =======
  function renderCommunities(items){
    if (!Array.isArray(items) || !items.length){
      grid.innerHTML = `<p class="empty">Tidak ada komunitas.</p>`;
      return;
    }
    grid.innerHTML = items.map(c => `
      <div class="community-card">
        <img src="${absUrl(c.profile_pic) || 'https://via.placeholder.com/600x400?text=%20'}" alt="${c.name}"/>
        <div class="community-overlay">
          <div class="community-name">${c.name}</div>
          <div class="community-members">${(c.member_count ?? c.members?.length) || 0} Members</div>
          <button class="join-btn" data-id="${c.id}">Join</button>
        </div>
      </div>
    `).join("");
  }

  // Delegated click for join
  grid.addEventListener("click", (e) => {
    const btn = e.target.closest(".join-btn");
    if (!btn) return;
    joinCommunity(btn.dataset.id, btn);
  });

  // Search handler
  searchForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    grid.innerHTML = `<p class="empty">Loading...</p>`;
    try{
      const q = qInput.value.trim();
      const data = q ? await fetchSearch(q) : await fetchExplore();
      renderCommunities(data || []);
    }catch(err){
      grid.innerHTML = `<p class="empty">Gagal memuat data.</p>`;
      console.warn(err);
    }
  });

  // ======= Boot: load recommendations =======
  (async function init(){
    grid.innerHTML = `<p class="empty">Loading...</p>`;
    try{
      const data = await fetchExplore();
      renderCommunities(data || []);
    }catch(err){
      grid.innerHTML = `<p class="empty">Gagal memuat data.</p>`;
      console.warn(err);
    }
  })();

  // ======= Modal Controls =======
  const joinLinkBtn = document.getElementById('joinLinkBtn');
  const startCommunityBtn = document.getElementById('startCommunityBtn');
  const joinLinkModal = document.getElementById('joinLinkModal');
  const startCommunityModal = document.getElementById('startCommunityModal');
  const closeJoinModal = document.getElementById('closeJoinModal');
  const closeStartModal = document.getElementById('closeStartModal'); // baru
  const saveCommunityBtn = document.getElementById('saveCommunityBtn');

  // Open modals
  joinLinkBtn?.addEventListener('click', () => joinLinkModal.classList.add('active'));
  startCommunityBtn?.addEventListener('click', () => startCommunityModal.classList.add('active'));

  // Close buttons
  closeJoinModal?.addEventListener('click', () => joinLinkModal.classList.remove('active'));
  closeStartModal?.addEventListener('click', () => startCommunityModal.classList.remove('active'));

  // Save new community (contoh)
  saveCommunityBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    alert('Community saved!');
    startCommunityModal.classList.remove('active');
  });

  // Close jika klik overlay
  joinLinkModal?.addEventListener('click', (e) => {
    if (e.target === joinLinkModal) joinLinkModal.classList.remove('active');
  });
  startCommunityModal?.addEventListener('click', (e) => {
    if (e.target === startCommunityModal) startCommunityModal.classList.remove('active');
  });

  // Close dengan ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      joinLinkModal?.classList.remove('active');
      startCommunityModal?.classList.remove('active');
    }
  });

  // Join with link submit (contoh)
  document.getElementById('joinLinkForm')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const link = (document.getElementById('inviteLink') || {}).value?.trim();
    if (!link) return;
    alert(`Joining via link: ${link}`);
    joinLinkModal.classList.remove('active');
  });

  // Upload handlers (opsional)
  const profileUpload = document.getElementById('profileUpload');
  const profileInput = document.getElementById('profileInput');
  const bannerUpload = document.getElementById('bannerUpload');
  const bannerInput = document.getElementById('bannerInput');

  profileUpload?.addEventListener('click', () => profileInput?.click());
  bannerUpload?.addEventListener('click', () => bannerInput?.click());

  profileInput?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      profileUpload.innerHTML = `<img src="${ev.target.result}" class="preview-image" alt="Profile"/>`;
    };
    reader.readAsDataURL(file);
  });

  bannerInput?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      bannerUpload.innerHTML = `<img src="${ev.target.result}" class="preview-image" alt="Banner"/>`;
    };
    reader.readAsDataURL(file);
  });
</script>
</body>
</html>
