<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>CircleUP - Explore</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:#f5f5f5}
    .container{display:flex;min-height:100vh}

    /* Main */
    .main-content{margin-left:200px;flex:1;overflow-y:auto}

    /* Hero */
    .hero{background:linear-gradient(135deg,#c99746 0%,#b8863d 100%);padding:60px 40px;text-align:center;position:relative;overflow:hidden}
    .circles-pattern{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
    .circle{border:3px solid rgba(255,255,255,0.4);border-radius:50%;position:absolute}
    .circle:nth-child(1){top:10%;left:15%;width:120px;height:120px}
    .circle:nth-child(2){top:5%;left:35%;width:160px;height:160px}
    .circle:nth-child(3){top:8%;left:58%;width:140px;height:140px}
    .circle:nth-child(4){top:12%;right:10%;width:180px;height:180px}
    .circle:nth-child(5){top:35%;left:8%;width:150px;height:150px}
    .circle:nth-child(6){top:32%;left:28%;width:130px;height:130px}
    .hero h1{color:#fff;font-size:42px;font-weight:700;margin-bottom:16px;position:relative;z-index:1}
    .hero p{color:#fff;font-size:16px;max-width:650px;margin:0 auto 20px;line-height:1.6;position:relative;z-index:1}
    .hero-buttons{display:flex;gap:12px;justify-content:center;position:relative;z-index:1}
    .btn{padding:12px 22px;border:none;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s}
    .btn-light{background:#fff;color:#333}.btn-light:hover{background:#f0f0f0}
    .btn-dark{background:#3a3a3a;color:#fff}.btn-dark:hover{background:#2a2a2a}

    /* Search */
    .search-section{padding:28px 40px;max-width:1200px;margin:0 auto}
    .search-bar{display:flex;gap:10px;margin-bottom:24px}
    .search-input{flex:1;padding:14px 16px;border:none;background:#e8e8e8;border-radius:8px;font-size:15px;color:#444}
    .search-btn{padding:14px 18px;background:#c99746;border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:16px;transition:background 0.3s}
    .search-btn:hover{background:#b8863d}

    /* Grid */
    .communities-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .community-card{position:relative;border-radius:10px;overflow:hidden;height:230px;background:#ddd;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:transform 0.3s,box-shadow 0.3s}
    .community-card:hover{transform:translateY(-4px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .community-card img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
    .community-card:hover img{transform:scale(1.05)}
    .community-overlay{position:absolute;left:0;right:0;bottom:0;padding:20px;background:linear-gradient(to top,rgba(0,0,0,.85),rgba(0,0,0,.4) 60%,transparent);opacity:0;transition:opacity .3s ease}
    .community-card:hover .community-overlay{opacity:1}
    .community-name{color:#fff;font-size:20px;font-weight:700;margin-bottom:6px;text-shadow:0 2px 4px rgba(0,0,0,0.3)}
    .community-members{color:rgba(255,255,255,.9);font-size:13px;margin-bottom:10px}
    .join-btn{background:#fff;color:#333;border:none;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
    .join-btn:hover{transform:scale(1.05);background:#f0f0f0}
    .join-btn:disabled{background:#ccc;cursor:not-allowed;transform:scale(1)}
    .joined-badge{background:#4caf50;color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600}
    .empty{color:#666;padding:40px;text-align:center;font-size:16px}
    .error{color:#d32f2f;padding:40px;text-align:center;font-size:16px}

    /* Modal */
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
    .modal-overlay.active{display:flex}
    .modal{background:#fff;border-radius:12px;width:90%;max-width:540px;max-height:90vh;overflow:auto;position:relative}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid #e0e0e0}
    .modal-title{font-size:20px;font-weight:600;color:#1a1a1a}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#666;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%}
    .modal-close:hover{background:#f0f0f0}
    .modal-body{padding:24px}
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:15px;font-weight:600;color:#1a1a1a;margin-bottom:8px}
    .form-input,.form-textarea{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;font-family:'Poppins',sans-serif;background:#f8f8f8}
    .form-input:focus,.form-textarea:focus{outline:none;border-color:#c99746;background:#fff}
    .form-textarea{min-height:120px;resize:vertical}
    .modal-btn,.save-btn{padding:12px 24px;border:none;border-radius:25px;font-size:15px;font-weight:600;cursor:pointer;transition:background 0.3s}
    .modal-btn{width:100%;background:#3a3a3a;color:#fff;margin-top:8px}
    .modal-btn:hover{background:#2a2a2a}
    .modal-btn:disabled{background:#999;cursor:not-allowed}
    .save-btn{background:#3a3a3a;color:#fff}
    .save-btn:hover{background:#2a2a2a}
    .save-btn:disabled{background:#999;cursor:not-allowed}

    /* Upload */
    .image-upload-section{margin-bottom:24px}
    .image-upload-grid{display:flex;gap:12px;align-items:flex-start}
    .profile-upload,.banner-upload{position:relative;background:#f0f0f0;border-radius:8px;overflow:hidden;cursor:pointer;border:2px dashed #ccc;transition:border-color 0.3s}
    .profile-upload:hover,.banner-upload:hover{border-color:#c99746}
    .profile-upload{width:120px;height:120px;flex-shrink:0}
    .banner-upload{flex:1;height:180px}
    .upload-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#666}
    .upload-icon{font-size:32px;margin-bottom:8px}
    .upload-text{font-size:13px}
    .preview-image{width:100%;height:100%;object-fit:cover}
    .upload-input{display:none}

    /* Community Detail Popup */
    .detail-modal{max-width:700px}
    .detail-banner{width:100%;height:200px;object-fit:cover}
    .detail-profile-section{display:flex;gap:20px;padding:24px;align-items:flex-start}
    .detail-profile-pic{width:100px;height:100px;border-radius:50%;object-fit:cover;border:4px solid #fff;margin-top:-50px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .detail-info{flex:1}
    .detail-community-name{font-size:20px;font-weight:700;color:#1a1a1a;margin-bottom:8px}
    .detail-stats{display:flex;gap:10px;margin-bottom:12px}
    .detail-stat{color:#666;font-size:14px}
    .detail-stat strong{color:#1a1a1a;font-weight:600}
    .detail-bio{color:#444;font-size:15px;line-height:1.6;margin-bottom:16px}
    .detail-location{color:#666;font-size:14px;display:flex;align-items:center;gap:6px;margin-bottom:20px}
    .detail-actions{display:flex;gap:12px}
    .detail-join-btn,.detail-visit-btn{padding:12px 24px;border:none;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s}
    .detail-join-btn{background:#c99746;color:#fff}
    .detail-join-btn:hover{background:#b8863d}
    .detail-join-btn.joined{background:#4caf50}
    .detail-visit-btn{background:#3a3a3a;color:#fff}
    .detail-visit-btn:hover{background:#2a2a2a}

    @media(max-width:768px){
      .main-content{margin-left:0}
      .communities-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
      .hero h1{font-size:32px}
      .hero p{font-size:14px}
      .detail-profile-section{flex-direction:column;align-items:center;text-align:center}
      .detail-profile-pic{margin-top:-50px}
    }
  </style>
</head>
<body>
  
  {% include "circleup/sidebar.html" %}

<div class="container">
  <div class="main-content">
    <!-- Hero -->
    <section class="hero">
      <div class="circles-pattern">
        <div class="circle"></div><div class="circle"></div><div class="circle"></div>
        <div class="circle"></div><div class="circle"></div><div class="circle"></div>
      </div>
      <h1>FIND YOUR COMMUNITY</h1>
      <p>Looking for a place to belong? Search for a community that fits you, join instantly with a link, or start your own community and bring people together on CircleUP.</p>
      <div class="hero-buttons">
        <button class="btn btn-light" id="joinLinkBtn">Join with Link</button>
        <button class="btn btn-dark" id="startCommunityBtn">Start New Community</button>
      </div>
    </section>

    <!-- Search + Grid -->
    <section class="search-section">
      <form class="search-bar" id="searchForm">
        <input type="text" class="search-input" id="q" placeholder="Search communities..."/>
        <button class="search-btn" type="submit">üîç</button>
      </form>
      <div class="communities-grid" id="grid"></div>
    </section>
  </div>
</div>

<!-- Join with Link Modal -->
<div class="modal-overlay" id="joinLinkModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Join Community</h2>
      <button class="modal-close" id="closeJoinModal">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="joinLinkForm">
        <div class="form-group">
          <label class="form-label" for="inviteLink">Invite Link</label>
          <input id="inviteLink" type="text" class="form-input" placeholder="Paste invite link here..." required />
        </div>
        <button type="submit" class="modal-btn" id="joinLinkSubmitBtn">Join Community</button>
      </form>
    </div>
  </div>
</div>

<!-- Start New Community Modal -->
<div class="modal-overlay" id="startCommunityModal">
  <div class="modal">
    <div class="modal-header">
      <button class="modal-close" id="closeStartModal">‚úï</button>
      <h2 class="modal-title">Start New Community</h2>
      <button class="save-btn" id="saveCommunityBtn">Save</button>
    </div>
    <div class="modal-body">
      <form id="startCommunityForm">
        <div class="image-upload-section">
          <div class="image-upload-grid">
            <div class="profile-upload" id="profileUpload">
              <div class="upload-placeholder">
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">Profile</div>
              </div>
              <input type="file" class="upload-input" id="profileInput" accept="image/*" />
            </div>
            <div class="banner-upload" id="bannerUpload">
              <div class="upload-placeholder">
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">Banner</div>
              </div>
              <input type="file" class="upload-input" id="bannerInput" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="communityName">Community Name *</label>
          <input id="communityName" type="text" class="form-input" placeholder="Enter community name" required />
        </div>

        <div class="form-group">
          <label class="form-label" for="communityBio">Bio</label>
          <textarea id="communityBio" class="form-textarea" placeholder="Describe your community..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label" for="communityLocation">Location</label>
          <input id="communityLocation" type="text" class="form-input" placeholder="e.g., Indonesia, Global" value="Indonesia" />
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Community Detail Modal -->
<div class="modal-overlay" id="detailModal">
  <div class="modal detail-modal">
    <div class="modal-header">
      <h2 class="modal-title">Community Details</h2>
      <button class="modal-close" id="closeDetailModal">‚úï</button>
    </div>
    <div id="detailContent">
      <!-- Dynamic content will be inserted here -->
    </div>
  </div>
</div>

<script>
  // ============= CONFIG & AUTH =============
  const API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api";
  let accessToken = localStorage.getItem("access");
  
  // Auth guard
  if (!accessToken) {
    alert("Please login first!");
    window.location.href = "/login/";
  }

  // Helper: Build full URL for images
  function absUrl(url) {
    if (!url) return "https://via.placeholder.com/600x400?text=No+Image";
    if (url.startsWith("http")) return url;
    const root = API_BASE.replace(/\/api\/?$/, "");
    return `${root}${url.startsWith("/") ? "" : "/"}${url}`;
  }

  // üÜï Token Refresh Function
  async function refreshAccessToken() {
    const refreshToken = localStorage.getItem("refresh");
    
    if (!refreshToken) {
      return false;
    }

    try {
      const response = await fetch(`${API_BASE}/token/refresh/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ refresh: refreshToken })
      });

      if (response.ok) {
        const data = await response.json();
        localStorage.setItem("access", data.access);
        accessToken = data.access;
        return true;
      }
      return false;
    } catch (error) {
      console.error("Refresh failed:", error);
      return false;
    }
  }

  // üÜï Logout Handler
  function handleLogout() {
    localStorage.removeItem("access");
    localStorage.removeItem("refresh");
    alert("Session expired. Please login again.");
    window.location.href = "/login/";
  }

  // üîÑ Enhanced API Call with Token Refresh
  async function apiCall(endpoint, options = {}) {
    const headers = {
      Authorization: `Bearer ${accessToken}`,
      ...options.headers
    };

    if (!(options.body instanceof FormData)) {
      headers["Content-Type"] = "application/json";
    }

    try {
      let response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers
      });

      // üîÑ Handle 401 with token refresh
      if (response.status === 401) {
        const refreshed = await refreshAccessToken();
        
        if (refreshed) {
          // Retry request dengan token baru
          headers.Authorization = `Bearer ${accessToken}`;
          response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers
          });
        } else {
          handleLogout();
          throw new Error("Unauthorized");
        }
      }

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.detail || errorData.error || `HTTP ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error("API Error:", error);
      throw error;
    }
  }

  // ============= DOM ELEMENTS =============
  const grid = document.getElementById("grid");
  const searchForm = document.getElementById("searchForm");
  const qInput = document.getElementById("q");
  
  // Modal elements
  const joinLinkBtn = document.getElementById("joinLinkBtn");
  const startCommunityBtn = document.getElementById("startCommunityBtn");
  const joinLinkModal = document.getElementById("joinLinkModal");
  const startCommunityModal = document.getElementById("startCommunityModal");
  const detailModal = document.getElementById("detailModal");
  const closeJoinModal = document.getElementById("closeJoinModal");
  const closeStartModal = document.getElementById("closeStartModal");
  const closeDetailModal = document.getElementById("closeDetailModal");
  const saveCommunityBtn = document.getElementById("saveCommunityBtn");
  const profileUpload = document.getElementById("profileUpload");
  const profileInput = document.getElementById("profileInput");
  const bannerUpload = document.getElementById("bannerUpload");
  const bannerInput = document.getElementById("bannerInput");
  const joinLinkForm = document.getElementById("joinLinkForm");
  const joinLinkSubmitBtn = document.getElementById("joinLinkSubmitBtn");

  // ============= API FUNCTIONS =============
  async function fetchExplore() {
    return await apiCall("/communities/explore/");
  }

  async function fetchSearch(query) {
    return await apiCall(`/communities/search/?q=${encodeURIComponent(query)}`);
  }

  async function joinCommunity(id) {
    return await apiCall(`/communities/${id}/join/`, { method: "POST" });
  }

  async function createCommunity(formData) {
    return await apiCall("/communities/", {
      method: "POST",
      body: formData
    });
  }

  async function fetchCommunityDetail(id) {
    return await apiCall(`/communities/${id}/`);
  }

  // üÜï Join via invite link
  async function joinViaInviteLink(inviteLink) {
    // Extract community ID or invite code from link
    // Assuming format: http://domain.com/invite/{invite_code}
    const linkParts = inviteLink.split('/');
    const inviteCode = linkParts[linkParts.length - 1] || inviteLink;
    
    // Find community by invite_link
    const communities = await apiCall("/communities/");
    const community = communities.results.find(c => c.invite_link === inviteCode);
    
    if (!community) {
      throw new Error("Invalid invite link");
    }
    
    return await joinCommunity(community.id);
  }

  // ============= RENDER FUNCTIONS =============
  function renderCommunities(items) {
    if (!Array.isArray(items) || items.length === 0) {
      grid.innerHTML = '<p class="empty">No communities found. Try a different search or create your own!</p>';
      return;
    }

    grid.innerHTML = items.map(community => {
      const memberCount = community.member_count || 0;
      const isJoined = community.is_member || false;
      
      return `
        <div class="community-card" data-id="${community.id}">
          <img src="${absUrl(community.profile_pic)}" alt="${community.name}" />
          <div class="community-overlay">
            <div class="community-name">${community.name}</div>
            <div class="community-members">${memberCount} ${memberCount === 1 ? 'Member' :  'Members'}</div>
            ${isJoined 
              ? '<div class="joined-badge">Joined ‚úì</div>'
              : `<button class="join-btn" data-id="${community.id}" onclick="event.stopPropagation()">Join</button>`
            }
          </div>
        </div>
      `;
    }).join("");
  }

  function showLoading() {
    grid.innerHTML = '<p class="empty">Loading communities...</p>';
  }

  function showError(message) {
    grid.innerHTML = `<p class="error">‚ö†Ô∏è ${message}</p>`;
  }

  // üÜï Render Community Detail Popup
  function renderCommunityDetail(community) {
    const memberCount = community.member_count || 0;
    const onlineCount = community.online_count || 0;
    const isJoined = community.is_member || false;
    
    const detailContent = document.getElementById("detailContent");
    detailContent.innerHTML = `
      <img src="${absUrl(community.background_banner)}" alt="${community.name}" class="detail-banner" />
      <div class="detail-profile-section">
        <img src="${absUrl(community.profile_pic)}" alt="${community.name}" class="detail-profile-pic" />
        <div class="detail-info">
          <h2 class="detail-community-name">${community.name}</h2>
          <div class="detail-stats">
            <div class="detail-stat"><strong>${memberCount}</strong> Members</div>
            <div class="detail-stat"><strong>${onlineCount}</strong> Online</div>
          </div>
          <p class="detail-bio">${community.bio || 'No description available'}</p>
          <div class="detail-location">üìç ${community.location || 'Unknown'}</div>
          <div class="detail-actions">
            ${isJoined 
              ? `<button class="detail-visit-btn" onclick="visitCommunity('${community.id}')">Visit Community</button>`
              : `<button class="detail-join-btn" onclick="joinFromDetail('${community.id}')">Join Community</button>`
            }
          </div>
        </div>
      </div>
    `;
  }

  // ============= EVENT HANDLERS =============
  
  // üÜï Click card to show detail
  grid.addEventListener("click", async (e) => {
    const card = e.target.closest(".community-card");
    const btn = e.target.closest(".join-btn");
    
    // If clicking join button, handle join
    if (btn) {
      const communityId = btn.dataset.id;
      const originalText = btn.textContent;
      
      btn.disabled = true;
      btn.textContent = "Joining...";

      try {
        await joinCommunity(communityId);
        btn.textContent = "Joined ‚úì";
        btn.classList.remove("join-btn");
        btn.classList.add("joined-badge");
        
        setTimeout(() => {
          loadExplore();
        }, 1000);
      } catch (error) {
        alert(`Failed to join community: ${error.message}`);
        btn.disabled = false;
        btn.textContent = originalText;
      }
      return;
    }
    
    // If clicking card (not button), show detail
    if (card) {
      const communityId = card.dataset.id;
      try {
        const community = await fetchCommunityDetail(communityId);
        renderCommunityDetail(community);
        detailModal.classList.add("active");
      } catch (error) {
        alert(`Failed to load community details: ${error.message}`);
      }
    }
  });

  // üÜï Join from detail popup
  window.joinFromDetail = async function(communityId) {
    const btn = document.querySelector('.detail-join-btn');
    if (!btn) return;
    
    btn.disabled = true;
    btn.textContent = "Joining...";
    
    try {
      await joinCommunity(communityId);
      btn.textContent = "Joined ‚úì";
      btn.classList.add("joined");
      
      setTimeout(() => {
        detailModal.classList.remove("active");
        loadExplore();
      }, 1000);
    } catch (error) {
      alert(`Failed to join community: ${error.message}`);
      btn.disabled = false;
      btn.textContent = "Join Community";
    }
  };

  // üÜï Visit community (redirect to home/feeds)
  window.visitCommunity = function(communityId) {
    window.location.href = `/home/?community=${communityId}`;
  };

  // Search handler
  searchForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const query = qInput.value.trim();
    
    showLoading();
    
    try {
      const data = query ? await fetchSearch(query) : await fetchExplore();
      renderCommunities(data);
    } catch (error) {
      showError(`Failed to load communities: ${error.message}`);
    }
  });

  // ============= MODAL HANDLERS =============
  
  // Open/close modals
  joinLinkBtn?.addEventListener("click", () => joinLinkModal.classList.add("active"));
  startCommunityBtn?.addEventListener("click", () => startCommunityModal.classList.add("active"));
  closeJoinModal?.addEventListener("click", () => joinLinkModal.classList.remove("active"));
  closeStartModal?.addEventListener("click", () => startCommunityModal.classList.remove("active"));
  closeDetailModal?.addEventListener("click", () => detailModal.classList.remove("active"));

  // Close on overlay click
  [joinLinkModal, startCommunityModal, detailModal].forEach(modal => {
    modal?.addEventListener("click", (e) => {
      if (e.target === modal) modal.classList.remove("active");
    });
  });

  // Close on ESC key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      joinLinkModal?.classList.remove("active");
      startCommunityModal?.classList.remove("active");
      detailModal?.classList.remove("active");
    }
  });

  // üÜï Join with Link Form Handler
  joinLinkForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const inviteLinkInput = document.getElementById("inviteLink");
    const inviteLink = inviteLinkInput.value.trim();
    
    if (!inviteLink) {
      alert("Please paste an invite link!");
      return;
    }
    
    joinLinkSubmitBtn.disabled = true;
    joinLinkSubmitBtn.textContent = "Joining...";
    
    try {
      await joinViaInviteLink(inviteLink);
      alert("Successfully joined community! üéâ");
      
      // Close modal and reset
      joinLinkModal.classList.remove("active");
      inviteLinkInput.value = "";
      
      // Reload explore
      loadExplore();
    } catch (error) {
      alert(`Failed to join community: ${error.message}`);
    } finally {
      joinLinkSubmitBtn.disabled = false;
      joinLinkSubmitBtn.textContent = "Join Community";
    }
  });

  // ============= IMAGE UPLOAD HANDLERS =============
  
  profileUpload?.addEventListener("click", () => profileInput?.click());
  bannerUpload?.addEventListener("click", () => bannerInput?.click());

  function handleImagePreview(input, container) {
    input?.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert("Image size must be less than 5MB");
        input.value = "";
        return;
      }

      // Validate file type
      if (!file.type.startsWith("image/")) {
        alert("Please select an image file");
        input.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = (ev) => {
        container.innerHTML = `<img src="${ev.target.result}" class="preview-image" alt="Preview" />`;
      };
      reader.readAsDataURL(file);
    });
  }

  handleImagePreview(profileInput, profileUpload);
  handleImagePreview(bannerInput, bannerUpload);

  // ============= CREATE COMMUNITY HANDLER =============
  
  saveCommunityBtn?.addEventListener("click", async (e) => {
    e.preventDefault();

    const nameInput = document.getElementById("communityName");
    const bioInput = document.getElementById("communityBio");
    const locationInput = document.getElementById("communityLocation");
    const profileFile = profileInput?.files[0];
    const bannerFile = bannerInput?.files[0];

    // Validation
    if (!nameInput?.value?.trim()) {
      alert("Community name is required!");
      nameInput.focus();
      return;
    }

    if (!profileFile) {
      alert("Profile picture is required!");
      return;
    }

    if (!bannerFile) {
      alert("Banner image is required!");
      return;
    }

    // Disable button
    saveCommunityBtn.disabled = true;
    saveCommunityBtn.textContent = "Creating...";

    try {
      const formData = new FormData();
      formData.append("name", nameInput.value.trim());
      formData.append("bio", bioInput?.value?.trim() || "No description yet");
      formData.append("location", locationInput?.value?.trim() || "Indonesia");
      formData.append("profile_pic", profileFile);
      formData.append("background_banner", bannerFile);
      formData.append("is_public", "true");

      const newCommunity = await createCommunity(formData);
      
      alert(`Community "${newCommunity.name}" created successfully! üéâ`);

      // Close modal and reset form
      startCommunityModal.classList.remove("active");
      document.getElementById("startCommunityForm").reset();
      profileUpload.innerHTML = '<div class="upload-placeholder"><div class="upload-icon">üì∑</div><div class="upload-text">Profile</div></div>';
      bannerUpload.innerHTML = '<div class="upload-placeholder"><div class="upload-icon">üì∑</div><div class="upload-text">Banner</div></div>';

      // Redirect to the new community
      setTimeout(() => {
        window.location.href = `/home/?community=${newCommunity.id}`;
      }, 1000);

    } catch (error) {
      alert(`Failed to create community: ${error.message}`);
    } finally {
      saveCommunityBtn.disabled = false;
      saveCommunityBtn.textContent = "Save";
    }
  });

  // ============= INIT =============
  
  async function loadExplore() {
    showLoading();
    try {
      const data = await fetchExplore();
      renderCommunities(data);
    } catch (error) {
      showError(`Failed to load communities: ${error.message}`);
    }
  }

  // Boot app
  loadExplore();
</script>
</body>
</html>