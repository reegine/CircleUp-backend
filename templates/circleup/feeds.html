<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CircleUP ‚Äì Feeds</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
    :root{--bg:#f9f9fb;--bd:#ececec;--text:#1f2937;--muted:#6b7280;--brand:#e59d2c;--card:#ffffff}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;color:var(--text);background:var(--bg);display:flex;overflow:hidden}
    a{color:inherit;text-decoration:none}
    
    /* ===== COMMUNITY LIST SIDEBAR ===== */
    .community-list-sidebar {
      width: 250px;
      height: 100vh;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      position: fixed;
      left: 200px;
      top: 0;
      z-index: 999;
      display: flex;
      flex-direction: column;
    }

    .community-list-header {
      padding: 24px 20px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }

    .community-list-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .community-list-stats {
      font-size: 14px;
      color: #666;
    }

    .communities-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .communities-container::-webkit-scrollbar {
      width: 8px;
    }

    .communities-container::-webkit-scrollbar-thumb {
      background: #ddd;
      border-radius: 8px;
    }

    .community-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-radius: 12px;
      background: #fff;
      border: 2px solid #eee;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: inherit;
    }

    .community-card:hover {
      border-color: #e59d2c;
      background: #fef9f2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .community-card.active {
      border-color: #e59d2c;
      background: #fff3e0;
      border-left: 4px solid #e59d2c;
    }

    .community-card-avatar {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      background: #eaeaea;
      flex-shrink: 0;
    }

    .community-card-info {
      flex: 1;
      min-width: 0;
    }

    .community-card-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .community-card-members {
      font-size: 13px;
      color: #666;
    }

    .layout{display:flex;min-height:100vh}
    .main{flex:1;display:flex;gap:20px;padding:20px;margin-left:450px;overflow:hidden;height:100vh}
    .content{flex:1;max-width:920px;overflow-y:auto;display:flex;flex-direction:column}
    .content::-webkit-scrollbar{width:10px}
    .content::-webkit-scrollbar-thumb{background:#ddd;border-radius:10px}
    
    .page-head{margin-bottom:20px;flex-shrink:0}
    .page-head h2{margin:0 0 6px 0;font-size:24px;font-weight:600}
    .page-head .meta{color:var(--muted);font-size:14px}
    .toolbar{display:flex;justify-content:flex-start;align-items:center;margin-bottom:20px;gap:12px;flex-shrink:0}
    .post-btn{background:var(--brand);color:#fff;border:none;border-radius:25px;padding:12px 24px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;transition:all 0.2s}
    .post-btn:hover{background:#d48d1f;transform:translateY(-1px)}
    .feeds-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:16px;margin-bottom:24px;flex:1;align-content:start}
    .feed-card{background:var(--card);border-radius:14px;overflow:hidden;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;height:fit-content}
    .feed-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,0.1)}
    .feed-card-img{width:100%;aspect-ratio:1;object-fit:cover}
    .feed-card-content{padding:12px}
    .feed-card-author{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .feed-card-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover}
    .feed-card-name{font-weight:600;font-size:13px}
    .feed-card-time{font-size:11px;color:var(--muted);margin-left:auto}
    .feed-card-caption{font-size:13px;line-height:1.4;color:var(--text);display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden}
    .feed-card-reactions{display:flex;gap:6px;margin-top:8px;font-size:12px}
    .reaction-count-badge{background:#f5f5f5;padding:4px 8px;border-radius:12px;display:flex;align-items:center;gap:4px}
    .empty{color:#94a3b8;padding:40px;text-align:center;background:#fff;border-radius:14px}
    .warn{background:#fff8e1;border:1px solid #ffe08a;color:#6b5b00;border-radius:10px;padding:12px;margin-bottom:12px;flex-shrink:0}
    .spinner{width:40px;height:40px;border-radius:50%;border:4px solid #e5e7eb;border-top-color:var(--brand);animation:spin .8s linear infinite;margin:40px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;padding:20px}
    .modal-overlay.active{display:flex}
    .modal-content{background:#fff;border-radius:20px;max-width:900px;width:100%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;animation:modalIn 0.3s ease}
    @keyframes modalIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--bd)}
    .modal-header h3{font-size:18px;font-weight:600}
    .modal-close{background:none;border:none;font-size:28px;cursor:pointer;color:var(--muted);line-height:1;padding:0;width:32px;height:32px}
    .modal-close:hover{color:var(--text)}
    .modal-body{padding:24px;overflow-y:auto;flex:1}
    .post-detail{display:flex;gap:24px}
    .post-image-large{flex:1;max-width:500px}
    .post-image-large img{width:100%;border-radius:14px;display:block}
    .post-info{flex:1;display:flex;flex-direction:column}
    .post-author-detail{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--bd)}
    .post-avatar-large{width:42px;height:42px;border-radius:50%;object-fit:cover}
    .post-author-name{font-weight:600;font-size:15px}
    .post-author-time{font-size:12px;color:var(--muted);margin-top:2px}
    .post-caption-full{font-size:14px;line-height:1.6;margin-bottom:20px}
    
    /* ===== REACTION PICKER IN MODAL ===== */
    .post-reactions-full{
      padding:16px 0;
      border-top:1px solid var(--bd);
      border-bottom:1px solid var(--bd);
      margin-bottom:16px;
      position:relative;
    }
    
    .modal-reaction-wrapper{
      position:relative;
      display:inline-block;
    }
    
    .modal-main-reaction-btn{
      border:none;
      border-radius:25px;
      padding:10px 20px;
      font-size:16px;
      cursor:pointer;
      background:#f1f1f1;
      transition:all .2s ease;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:500;
      color:#666;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    
    .modal-main-reaction-btn:hover{
      background:#e8e8e8;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,.12);
    }
    
    .modal-main-reaction-btn.reacted{
      background:#ffd93d;
      color:#333;
    }
    
    .modal-reaction-picker{
      position:absolute;
      bottom:calc(100% + 8px);
      left:0;
      background:white;
      border-radius:30px;
      padding:8px 12px;
      box-shadow:0 4px 20px rgba(0,0,0,.15);
      display:none;
      gap:6px;
      z-index:100;
      animation:popIn .2s ease;
    }
    
    @keyframes popIn{
      from{
        opacity:0;
        transform:scale(0.8) translateY(10px);
      }
      to{
        opacity:1;
        transform:scale(1) translateY(0);
      }
    }
    
    .modal-reaction-picker.show{
      display:flex;
    }
    
    .modal-reaction-option{
      border:none;
      background:transparent;
      font-size:32px;
      cursor:pointer;
      padding:2px 4px;
      border-radius:50%;
      transition:all .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      width:48px;
      height:48px;
    }
    
    .modal-reaction-option:hover{
      transform:scale(1.3);
      background:#f5f5f5;
    }
    
    .modal-reaction-option:active{
      transform:scale(1.1);
    }
    
    .create-post-body{padding:24px;overflow-y:auto;max-height:calc(90vh - 80px)}
    .create-post-body::-webkit-scrollbar{width:8px}
    .create-post-body::-webkit-scrollbar-thumb{background:#ddd;border-radius:8px}
    .upload-area{border:2px dashed var(--bd);border-radius:14px;padding:60px 40px;text-align:center;margin-bottom:20px;cursor:pointer;transition:all 0.2s}
    .upload-area:hover{border-color:var(--brand);background:#fafafa}
    .upload-icon{font-size:48px;margin-bottom:12px;color:var(--muted)}
    .upload-text{color:var(--muted);margin-bottom:16px;font-size:14px}
    .upload-btn{background:#333;color:#fff;border:none;padding:10px 24px;border-radius:20px;cursor:pointer;font-size:14px;transition:all .2s}
    .upload-btn:hover{background:#1a1a1a;transform:translateY(-1px)}
    .preview-image{width:100%;border-radius:14px;display:block;max-height:400px;object-fit:contain;background:#f5f5f5}
    #imagePreviewContainer{margin-bottom:20px}
    .photo-actions{display:flex;gap:8px;margin-top:12px}
    .change-photo-btn,.cancel-photo-btn{padding:10px 20px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;border:none;flex:1}
    .change-photo-btn{background:var(--brand);color:#fff}
    .change-photo-btn:hover{background:#d48d1f;transform:translateY(-1px)}
    .cancel-photo-btn{background:#f5f5f5;color:#666}
    .cancel-photo-btn:hover{background:#e0e0e0}
    .caption-area{width:100%;border:1px solid var(--bd);border-radius:14px;padding:16px;font-size:14px;font-family:'Poppins',sans-serif;resize:vertical;min-height:120px;margin-bottom:16px}
    .post-submit-btn{width:100%;background:var(--brand);color:#fff;border:none;padding:14px;border-radius:25px;font-weight:600;cursor:pointer;font-size:15px;transition:all .2s}
    .post-submit-btn:hover{background:#d48d1f;transform:translateY(-1px)}
    .post-submit-btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
    /* RIGHT SIDEBAR - konsisten dengan chat.html */
    .right-sidebar {
      width: 280px;
      background: white;
      border-left: 1px solid #e0e0e0;
      overflow-y: auto;
      height: 100vh;
      flex-shrink: 0;
    }

    .right-sidebar::-webkit-scrollbar {
      width: 8px;
    }

    .right-sidebar::-webkit-scrollbar-thumb {
      background: #ddd;
      border-radius: 8px;
    }

    .rs-banner {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }

    .rs-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .rs-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #333;
    }

    .rs-counts {
      font-size: 13px;
      color: #666;
    }

    .rs-section {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .rs-section-title {
      font-size: 13px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .channel-item, .event-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 14px;
      color: #333;
      text-decoration: none;
      transition: all 0.2s;
    }

    .channel-item:hover, .event-item:hover {
      background: #f5f5f5;
    }

    .channel-item.active {
      background: #fff3e0;
      font-weight: 600;
      color: #e59d2c;
    }

    .channel-item svg, .event-item svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .empty {
      padding: 12px;
      color: #888;
      font-size: 13px;
      text-align: center;
    }

  </style>
</head>
<body>
  {% include "circleup/sidebar.html" %}

  <!-- COMMUNITY LIST SIDEBAR -->
  <aside class="community-list-sidebar">
    <div class="community-list-header">
      <div class="community-list-title" id="currentCommunityName">Community</div>
      <div class="community-list-stats" id="currentCommunityStats">0 Members ¬∑ 0 Online</div>
    </div>
    
    <div class="communities-container" id="communitiesContainer">
      <div style="text-align:center;padding:40px;color:#888">Loading communities...</div>
    </div>
  </aside>

  <div class="layout">
    <main class="main">
      <section class="content">
        <div id="needCommunity" class="warn" style="display:none">
          Tambahkan parameter <code>?community=&lt;uuid&gt;</code> pada URL untuk memuat Feeds komunitas.
        </div>
        
        <header class="page-head">
          <h2 data-page="name">Community Feeds</h2>
          <div data-page="counts" class="meta">0 Members, 0 Online</div>
        </header>
        
        <div class="toolbar">
          <button id="createPostBtn" class="post-btn"><span>+</span> Post</button>
        </div>
        
        <div id="feed" class="feeds-grid"></div>
        <div id="loading" class="spinner" style="display:none"></div>
      </section>
      
      <!-- PINDAHKAN RIGHT SIDEBAR KE DALAM .main -->
      {% include "circleup/right-sidebar.html" %}
      
    </main>
  </div>
  
  <div id="postModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Post Details</h3>
        <button class="modal-close" onclick="closePostModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="postDetailContent" class="post-detail"></div>
      </div>
    </div>
  </div>
  
<div id="createPostModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create new post</h3>
        <button class="modal-close" onclick="closeCreatePostModal()">&times;</button>
      </div>
      <div class="create-post-body">
        <div id="uploadArea" class="upload-area">
          <div class="upload-icon">üñºÔ∏è üé•</div>
          <div class="upload-text">Drag photos and videos here</div>
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Select from computer</button>
          <input type="file" id="fileInput" accept="image/*" style="display:none">
        </div>
        <div id="imagePreviewContainer" style="display:none;">
          <div style="position:relative;">
            <img id="previewImage" class="preview-image" alt="Preview">
            <div style="display:flex;gap:8px;margin-top:12px;">
              <button class="change-photo-btn" onclick="document.getElementById('fileInput').click()">Change Photo</button>
              <button class="cancel-photo-btn" onclick="cancelPhoto()">Cancel</button>
            </div>
          </div>
        </div>
        <textarea id="captionInput" class="caption-area" placeholder="Type something here!"></textarea>
        <button id="submitPost" class="post-submit-btn">Post</button>
      </div>
    </div>
  </div>


<script>
(function(){
  const API_BASE = (localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api").replace(/\/$/,"");
  const ACCESS = localStorage.getItem("access");
  const HEADERS = ACCESS ? {Authorization:`Bearer ${ACCESS}`, "Content-Type": "application/json"} : {};
  const q = new URLSearchParams(location.search);
  let COMM_ID = q.get("community");
  const feedEl = document.getElementById('feed');
  const spinner = document.getElementById('loading');
  let allPosts = [];
  let allCommunities = [];
  let currentSort = 'newest';
  let selectedFile = null;
  let currentPostForModal = null;

  // === TAMBAHAN BARU ===
  let currentUserProfile = null;

  // Fungsi untuk mendapatkan profil user saat ini
  async function getCurrentUserProfile(){
    try{
      const data = await fetchJSON(`${API_BASE}/users/profile/`);
      currentUserProfile = data;
      return data;
    }catch(e){
      console.warn('Failed to get user profile', e);
      return null;
    }
  }

  // Fungsi untuk mengecek apakah user adalah creator atau admin
  function checkPostPermission(community){
    const postBtn = document.getElementById('createPostBtn');
    if(!postBtn) return;
    
    // Jika belum ada data user atau community, hide button
    if(!currentUserProfile || !community){
      postBtn.style.display = 'none';
      return;
    }
    
    // Check if user is creator
    const isCreator = community.created_by && 
                      String(community.created_by.id || community.created_by) === String(currentUserProfile.id);
    
    // Check if user is admin (dari user_role yang ada di community serializer)
    const isAdmin = community.user_role === 'admin';
    
    // Show button hanya jika creator atau admin
    if(isCreator || isAdmin){
      postBtn.style.display = 'flex';
    } else {
      postBtn.style.display = 'none';
    }
  }
  // === END TAMBAHAN BARU ===


  // 6 REACTION TYPES sesuai API (sama dengan home.html)
  const REACTIONS = [
    { type: 'like', emoji: 'üëç', label: 'Like' },
    { type: 'love', emoji: '‚ù§Ô∏è', label: 'Love' },
    { type: 'laugh', emoji: 'üòÇ', label: 'Haha' },
    { type: 'wow', emoji: 'üòÆ', label: 'Wow' },
    { type: 'sad', emoji: 'üò¢', label: 'Sad' },
    { type: 'angry', emoji: 'üò†', label: 'Angry' }
  ];

  const abs = (u) => {
    if(!u) return "";
    if(/^https?:\/\//i.test(u)) return u;
    const root = API_BASE.replace(/\/api$/,'');
    return root + (u.startsWith('/') ? '' : '/') + u;
  };

  function escapeHtml(text){
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function fetchJSON(url, options = {}){
    const r = await fetch(url, {headers: HEADERS, ...options});
    if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  
  // ===== COMMUNITY LIST SIDEBAR =====
  async function loadCommunitiesList(){
    try{
      const data = await fetchJSON(`${API_BASE}/communities/joined/`);
      allCommunities = Array.isArray(data) ? data : [];
      renderCommunitiesList();
      
      if(!COMM_ID && allCommunities.length > 0){
        COMM_ID = allCommunities[0].id;
        const url = new URL(location.href);
        url.searchParams.set('community', COMM_ID);
        history.replaceState(null, '', url);
      }
    }catch(e){
      console.warn('Failed to load communities', e);
    }
  }

  function renderCommunitiesList(){
    const container = document.getElementById('communitiesContainer');
    if(!container) return;

    if(!allCommunities.length){
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#888">No communities joined yet</div>';
      return;
    }

    container.innerHTML = allCommunities.map(comm => {
      const isActive = String(comm.id) === String(COMM_ID);
      const thumb = abs(comm.profile_pic || comm.background_banner) || 'https://via.placeholder.com/60?text=C';
      
      return `
        <div class="community-card ${isActive ? 'active' : ''}"
             onclick="selectCommunity('${comm.id}')"
             data-community-id="${comm.id}">
          <img src="${escapeHtml(thumb)}" 
               alt="${escapeHtml(comm.name)}" 
               class="community-card-avatar"
               onerror="this.src='https://via.placeholder.com/60?text=C'">
          <div class="community-card-info">
            <div class="community-card-name">${escapeHtml(comm.name || 'Unnamed Community')}</div>
            <div class="community-card-members">${comm.member_count || 0} members</div>
          </div>
        </div>
      `;
    }).join('');

    updateCommunityListHeader();
  }

  function updateCommunityListHeader(){
    const currentComm = allCommunities.find(c => String(c.id) === String(COMM_ID));
    const titleEl = document.getElementById('currentCommunityName');
    const statsEl = document.getElementById('currentCommunityStats');
    
    if(currentComm){
      if(titleEl) titleEl.textContent = currentComm.name || 'Community';
      if(statsEl) statsEl.textContent = 
        `${currentComm.member_count || 0} Members ¬∑ ${currentComm.online_count || 0} Online`;
    }
  }

  window.selectCommunity = function(commId){
    COMM_ID = commId;
    const url = new URL(location.href);
    url.searchParams.set('community', COMM_ID);
    history.replaceState(null, '', url);
    
    renderCommunitiesList();
    updateSidebarLinks();
    loadCommunity();
    loadChannels();
    loadEvents();
    loadPosts();
  };

  function updateSidebarLinks(){
    document.querySelectorAll('.sidebar-menu a').forEach(a=>{
      const url = new URL(a.getAttribute('href'), location.origin);
      url.searchParams.set('community', COMM_ID);
      a.setAttribute('href', url.pathname + '?' + url.searchParams.toString());
    });
  }

  if(!COMM_ID){
    loadCommunitiesList().then(() => {
      if(COMM_ID){
        document.getElementById('needCommunity').style.display = 'none';
        boot();
      } else {
        document.getElementById('needCommunity').style.display = 'block';
      }
    });
  } else {
    loadCommunitiesList();
    boot();
  }

  // === MODIFIKASI loadCommunity() ===
  async function loadCommunity(){
    if(!COMM_ID) return;
    try{
      const c = await fetchJSON(`${API_BASE}/communities/${COMM_ID}/`);
      const pageName = document.querySelector('[data-page="name"]');
      const pageCnts = document.querySelector('[data-page="counts"]');
      const sImg = document.querySelector('[data-rs="image"]');
      const sNm = document.querySelector('[data-rs="name"]');
      const sCt = document.querySelector('[data-rs="counts"]');
      if(pageName) pageName.textContent = c.name || 'Community Feeds';
      const counts = `${c.member_count||0} Members, ${c.online_count||0} Online`;
      if(pageCnts) pageCnts.textContent = counts;
      if(sImg) sImg.src = abs(c.background_banner || c.profile_pic);
      if(sNm) sNm.textContent = c.name || 'Community';
      if(sCt) sCt.textContent = counts;

      // **TAMBAHAN BARU: Check post permission**
      checkPostPermission(c);

    }catch(e){console.warn('Community load failed', e);}
  }
  // === END MODIFIKASI loadCommunity() ===


  async function loadChannels(){
    if(!COMM_ID) return;
    const list = document.getElementById('channels-list');
    try{
      const data = await fetchJSON(`${API_BASE}/channels/`);
      const allChannels = Array.isArray(data) ? data : (data.results||[]);
      const items = allChannels.filter(c => String(c.community) === String(COMM_ID));
      list.innerHTML = items.length
        ? items.map(c=>`<a class="channel-item" href="/chat/?channel=${encodeURIComponent(c.id)}&community=${encodeURIComponent(COMM_ID)}">üí¨ ${escapeHtml(c.name)}</a>`).join('')
        : '<div class="empty">No channels</div>';
    }catch(e){
      console.warn('Channels load failed', e);
      list.innerHTML = '<div class="empty">Gagal memuat channels</div>';
    }
  }

  async function loadEvents(){
    if(!COMM_ID) return;
    const list = document.getElementById('events-list');
    try{
      const data = await fetchJSON(`${API_BASE}/events/`);
      const items = Array.isArray(data) ? data : (data.results||data||[]);
      const events = items.filter(e => (e.community && (String(e.community.id||e.community) === String(COMM_ID))));
      list.innerHTML = events.length
        ? events.map(e=>`<a class="event-item" href="/event-info/?community=${encodeURIComponent(COMM_ID)}#${e.id}">üìÖ ${escapeHtml(e.name)}</a>`).join('')
        : '<div class="empty">No events</div>';
    }catch(e){
      console.warn('Events load failed', e);
      list.innerHTML = '<div class="empty">Gagal memuat events</div>';
    }
  }

  async function loadPosts(){
    if(!COMM_ID) return;
    spinner.style.display = 'block';
    try{
      const url = `${API_BASE}/posts/?community=${encodeURIComponent(COMM_ID)}`;
      const data = await fetchJSON(url);
      const posts = Array.isArray(data) ? data : (data.results || []);
      allPosts = posts.filter(p => {
        if(p.community){
          const commId = p.community.id || p.community;
          return String(commId) === String(COMM_ID);
        }
        return false;
      });
      renderPosts();
    }catch(e){
      feedEl.innerHTML = '<div class="empty">Gagal memuat posts.</div>';
      console.warn('Posts load failed', e);
    }finally{
      spinner.style.display = 'none';
    }
  }

  function sortPosts(posts, sortType){
    const sorted = [...posts];
    if(sortType === 'newest'){
      sorted.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
    } else if(sortType === 'oldest'){
      sorted.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
    } else if(sortType === 'popular'){
      sorted.sort((a,b) => (b.like_count||0) - (a.like_count||0));
    }
    return sorted;
  }

  function renderPosts(){
    const sorted = sortPosts(allPosts, currentSort);
    if(!sorted.length){
      feedEl.innerHTML = '<div class="empty">Belum ada posting.</div>';
      return;
    }
    feedEl.innerHTML = sorted.map(p => {
      const author = p.posted_by?.username || p.posted_by?.email || 'Anon';
      const avatar = abs(p.posted_by?.profile_pic);
      const when = p.created_at ? new Date(p.created_at).toLocaleDateString() : '';
      const img = abs(p.image);
      const caption = p.caption || '';
      
      // Get user's current reaction
      const userReaction = p.user_reaction;
      const reactionEmoji = userReaction ? (REACTIONS.find(r => r.type === userReaction)?.emoji || 'üòä') : 'üòä';
      
      return `
        <article class="feed-card" onclick="openPostModal('${p.id}')">
          ${img ? `<img class="feed-card-img" src="${img}" alt="post">` : ''}
          <div class="feed-card-content">
            <div class="feed-card-author">
              <img class="feed-card-avatar" src="${avatar||'https://via.placeholder.com/28'}" alt="${escapeHtml(author)}">
              <span class="feed-card-name">${escapeHtml(author)}</span>
              <span class="feed-card-time">${when}</span>
            </div>
            ${caption ? `<div class="feed-card-caption">${escapeHtml(caption)}</div>` : ''}
            <div class="feed-card-reactions">
              <span class="reaction-count-badge">${reactionEmoji} ${p.like_count||0}</span>
            </div>
          </div>
        </article>
      `;
    }).join('');
  }

  // === MODIFIKASI boot() ===
  async function boot(){
    // **Load user profile dulu**
    await getCurrentUserProfile();

    updateSidebarLinks();
    Promise.all([loadCommunity(), loadChannels(), loadEvents()]).then(()=>{
      loadPosts();
    });
  }
  // === END MODIFIKASI boot() ===

})();
// Handle file input change
document.getElementById('fileInput').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(file){
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = function(evt){
      document.getElementById('previewImage').src = evt.target.result;
      document.getElementById('uploadArea').style.display = 'none';
      document.getElementById('imagePreviewContainer').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});

// Cancel photo function
window.cancelPhoto = function(){
  selectedFile = null;
  document.getElementById('fileInput').value = '';
  document.getElementById('previewImage').src = '';
  document.getElementById('uploadArea').style.display = 'block';
  document.getElementById('imagePreviewContainer').style.display = 'none';
};

// Create post button handler
document.getElementById('createPostBtn').addEventListener('click', function(){
  document.getElementById('createPostModal').classList.add('active');
});

// Close modal function
window.closeCreatePostModal = function(){
  document.getElementById('createPostModal').classList.remove('active');
  cancelPhoto();
  document.getElementById('captionInput').value = '';
};

// Submit post handler
document.getElementById('submitPost').addEventListener('click', async function(){
  const caption = document.getElementById('captionInput').value.trim();
  
  if(!selectedFile && !caption){
    alert('Please add a photo or write something!');
    return;
  }
  
  try{
    const formData = new FormData();
    if(selectedFile) formData.append('image', selectedFile);
    if(caption) formData.append('caption', caption);
    formData.append('community', COMM_ID);
    
    const response = await fetch(`${API_BASE}/posts/`, {
      method: 'POST',
      headers: {Authorization: `Bearer ${ACCESS}`},
      body: formData
    });
    
    if(!response.ok) throw new Error('Failed to create post');
    
    closeCreatePostModal();
    loadPosts(); // Reload posts
    alert('Post created successfully!');
  }catch(e){
    console.error('Post creation failed:', e);
    alert('Failed to create post. Please try again.');
  }
});
</script>

</body>
</html>