<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CircleUP ‚Äì Feeds</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f9f9fb;--bd:#ececec;--text:#1f2937;--muted:#6b7280;--brand:#e59d2c;--card:#ffffff}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;color:var(--text);background:var(--bg);display:flex;overflow:hidden}
    a{color:inherit;text-decoration:none}
    
    /* ===== COMMUNITY LIST SIDEBAR ===== */
    .community-list-sidebar {
      width: 250px;
      height: 100vh;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      position: fixed;
      left: 200px;
      top: 0;
      z-index: 999;
      display: flex;
      flex-direction: column;
    }

    .community-list-header {
      padding: 24px 20px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }

    .community-list-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .community-list-stats {
      font-size: 14px;
      color: #666;
    }

    .communities-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .communities-container::-webkit-scrollbar {
      width: 8px;
    }

    .communities-container::-webkit-scrollbar-thumb {
      background: #ddd;
      border-radius: 8px;
    }

    .community-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-radius: 12px;
      background: #fff;
      border: 2px solid #eee;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: inherit;
    }

    .community-card:hover {
      border-color: #e59d2c;
      background: #fef9f2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .community-card.active {
      border-color: #e59d2c;
      background: #fff3e0;
      border-left: 4px solid #e59d2c;
    }

    .community-card-avatar {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      background: #eaeaea;
      flex-shrink: 0;
    }

    .community-card-info {
      flex: 1;
      min-width: 0;
    }

    .community-card-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .community-card-members {
      font-size: 13px;
      color: #666;
    }

    .layout{display:flex;min-height:100vh}
    .main{flex:1;display:flex;gap:20px;padding:20px;margin-left:450px;overflow:hidden;height:100vh}
    .content{flex:1;max-width:920px;overflow-y:auto;display:flex;flex-direction:column}
    .content::-webkit-scrollbar{width:10px}
    .content::-webkit-scrollbar-thumb{background:#ddd;border-radius:10px}
    
    .page-head{margin-bottom:20px;flex-shrink:0}
    .page-head h2{margin:0 0 6px 0;font-size:24px;font-weight:600}
    .page-head .meta{color:var(--muted);font-size:14px}
    .toolbar{display:flex;justify-content:flex-start;align-items:center;margin-bottom:20px;gap:12px;flex-shrink:0}
    .post-btn{background:var(--brand);color:#fff;border:none;border-radius:25px;padding:12px 24px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;transition:all 0.2s}
    .post-btn:hover{background:#d48d1f;transform:translateY(-1px)}
    .feeds-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:16px;margin-bottom:24px;flex:1;align-content:start}
    .feed-card{background:var(--card);border-radius:14px;overflow:hidden;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;height:fit-content}
    .feed-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,0.1)}
    .feed-card-img{width:100%;aspect-ratio:1;object-fit:cover}
    .feed-card-content{padding:12px}
    .feed-card-author{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .feed-card-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover}
    .feed-card-name{font-weight:600;font-size:13px}
    .feed-card-time{font-size:11px;color:var(--muted);margin-left:auto}
    .feed-card-caption{font-size:13px;line-height:1.4;color:var(--text);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .feed-card-reactions{display:flex;gap:6px;margin-top:8px;font-size:12px}
    .reaction-badge{background:#f5f5f5;padding:4px 8px;border-radius:12px;display:flex;align-items:center;gap:4px}
    .empty{color:#94a3b8;padding:40px;text-align:center;background:#fff;border-radius:14px}
    .warn{background:#fff8e1;border:1px solid #ffe08a;color:#6b5b00;border-radius:10px;padding:12px;margin-bottom:12px;flex-shrink:0}
    .spinner{width:40px;height:40px;border-radius:50%;border:4px solid #e5e7eb;border-top-color:var(--brand);animation:spin .8s linear infinite;margin:40px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;padding:20px}
    .modal-overlay.active{display:flex}
    .modal-content{background:#fff;border-radius:20px;max-width:900px;width:100%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;animation:modalIn 0.3s ease}
    @keyframes modalIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--bd)}
    .modal-header h3{font-size:18px;font-weight:600}
    .modal-close{background:none;border:none;font-size:28px;cursor:pointer;color:var(--muted);line-height:1;padding:0;width:32px;height:32px}
    .modal-close:hover{color:var(--text)}
    .modal-body{padding:24px;overflow-y:auto;flex:1}
    .post-detail{display:flex;gap:24px}
    .post-image-large{flex:1;max-width:500px}
    .post-image-large img{width:100%;border-radius:14px;display:block}
    .post-info{flex:1;display:flex;flex-direction:column}
    .post-author-detail{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--bd)}
    .post-avatar-large{width:42px;height:42px;border-radius:50%;object-fit:cover}
    .post-author-name{font-weight:600;font-size:15px}
    .post-author-time{font-size:12px;color:var(--muted);margin-top:2px}
    .post-caption-full{font-size:14px;line-height:1.6;margin-bottom:20px}
    .post-reactions-full{display:flex;gap:12px;flex-wrap:wrap;padding:16px 0;border-top:1px solid var(--bd);border-bottom:1px solid var(--bd);margin-bottom:16px}
    .reaction-btn{background:#f5f5f5;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:14px;transition:all 0.2s}
    .reaction-btn:hover{background:#e5e5e5;transform:scale(1.05)}
    .reaction-btn.active{background:#fff3e0;border:1px solid var(--brand)}
    .create-post-body{padding:24px}
    .upload-area{border:2px dashed var(--bd);border-radius:14px;padding:60px 40px;text-align:center;margin-bottom:20px;cursor:pointer;transition:all 0.2s}
    .upload-area:hover{border-color:var(--brand);background:#fafafa}
    .upload-area.has-image{padding:0;border:none}
    .upload-icon{font-size:48px;margin-bottom:12px;color:var(--muted)}
    .upload-text{color:var(--muted);margin-bottom:16px;font-size:14px}
    .upload-btn{background:#333;color:#fff;border:none;padding:10px 24px;border-radius:20px;cursor:pointer;font-size:14px}
    .preview-image{width:100%;border-radius:14px;display:block}
    .caption-area{width:100%;border:1px solid var(--bd);border-radius:14px;padding:16px;font-size:14px;font-family:'Poppins',sans-serif;resize:vertical;min-height:120px;margin-bottom:16px}
    .post-submit-btn{width:100%;background:var(--brand);color:#fff;border:none;padding:14px;border-radius:25px;font-weight:600;cursor:pointer;font-size:15px}
    .post-submit-btn:hover{background:#d48d1f}
    .post-submit-btn:disabled{background:#ccc;cursor:not-allowed}
    .right-sidebar {
      width: 250px;
      background: white;
      border-left: 1px solid #e0e0e0;
      padding: 20px;
      overflow-y: auto;
      height: 100vh;
      position: sticky;
      top: 0;
  }

  </style>
</head>
<body>
  {% include "circleup/sidebar.html" %}

  <!-- COMMUNITY LIST SIDEBAR -->
  <aside class="community-list-sidebar">
    <div class="community-list-header">
      <div class="community-list-title" id="currentCommunityName">Community</div>
      <div class="community-list-stats" id="currentCommunityStats">0 Members ¬∑ 0 Online</div>
    </div>
    
    <div class="communities-container" id="communitiesContainer">
      <div style="text-align:center;padding:40px;color:#888">Loading communities...</div>
    </div>
  </aside>

  <div class="layout">
    <main class="main">
      <section class="content">
        <div id="needCommunity" class="warn" style="display:none">
          Tambahkan parameter <code>?community=&lt;uuid&gt;</code> pada URL untuk memuat Feeds komunitas.
        </div>
        
        <header class="page-head">
          <h2 data-page="name">Community Feeds</h2>
          <div data-page="counts" class="meta">0 Members, 0 Online</div>
        </header>
        
        <div class="toolbar">
          <button id="createPostBtn" class="post-btn"><span>+</span> Post</button>
        </div>
        
        <div id="feed" class="feeds-grid"></div>
        <div id="loading" class="spinner" style="display:none"></div>
      </section>
      

    </main>
  </div>
  
  <div id="postModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Post Details</h3>
        <button class="modal-close" onclick="closePostModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="postDetailContent" class="post-detail"></div>
      </div>
    </div>
  </div>
  
  <div id="createPostModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create new post</h3>
        <button class="modal-close" onclick="closeCreatePostModal()">&times;</button>
      </div>
      <div class="create-post-body">
        <div id="uploadArea" class="upload-area">
          <div class="upload-icon">üñºÔ∏è üé•</div>
          <div class="upload-text">Drag photos and videos here</div>
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Select from computer</button>
          <input type="file" id="fileInput" accept="image/*" style="display:none">
        </div>
        <textarea id="captionInput" class="caption-area" placeholder="Type something here!"></textarea>
        <button id="submitPost" class="post-submit-btn">Post</button>
      </div>
    </div>
  </div>
    {% include "circleup/right-sidebar.html" %}

<script>
(function(){
  const API_BASE = (localStorage.getItem("API_BASE") || "http://127.0.0.1:8000/api").replace(/\/$/,"");
  const ACCESS = localStorage.getItem("access");
  const HEADERS = ACCESS ? {Authorization:`Bearer ${ACCESS}`, "Content-Type": "application/json"} : {};
  const q = new URLSearchParams(location.search);
  let COMM_ID = q.get("community");
  const feedEl = document.getElementById('feed');
  const spinner = document.getElementById('loading');
  let allPosts = [];
  let allCommunities = [];
  let currentSort = 'newest';
  let selectedFile = null;
  let currentPostForModal = null;

  const REACTIONS = [
    { type: 'love', emoji: '‚ù§Ô∏è', label: 'Love' },
    { type: 'like', emoji: 'üëç', label: 'Like' },
    { type: 'laugh', emoji: 'üòÇ', label: 'Haha' },
    { type: 'wow', emoji: 'üòÆ', label: 'Wow' },
    { type: 'sad', emoji: 'üò¢', label: 'Sad' },
    { type: 'angry', emoji: 'üò†', label: 'Angry' }
  ];

  const abs = (u) => {
    if(!u) return "";
    if(/^https?:\/\//i.test(u)) return u;
    const root = API_BASE.replace(/\/api$/,'');
    return root + (u.startsWith('/') ? '' : '/') + u;
  };

  function escapeHtml(text){
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function fetchJSON(url, options = {}){
    const r = await fetch(url, {headers: HEADERS, ...options});
    if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  // ===== COMMUNITY LIST SIDEBAR =====
  async function loadCommunitiesList(){
    try{
      const data = await fetchJSON(`${API_BASE}/communities/joined/`);
      allCommunities = Array.isArray(data) ? data : [];
      renderCommunitiesList();
      
      if(!COMM_ID && allCommunities.length > 0){
        COMM_ID = allCommunities[0].id;
        const url = new URL(location.href);
        url.searchParams.set('community', COMM_ID);
        history.replaceState(null, '', url);
      }
    }catch(e){
      console.warn('Failed to load communities', e);
    }
  }

  function renderCommunitiesList(){
    const container = document.getElementById('communitiesContainer');
    if(!container) return;

    if(!allCommunities.length){
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#888">No communities joined yet</div>';
      return;
    }

    container.innerHTML = allCommunities.map(comm => {
      const isActive = String(comm.id) === String(COMM_ID);
      const thumb = abs(comm.profile_pic || comm.background_banner) || 'https://via.placeholder.com/60?text=C';
      
      return `
        <div class="community-card ${isActive ? 'active' : ''}"
             onclick="selectCommunity('${comm.id}')"
             data-community-id="${comm.id}">
          <img src="${escapeHtml(thumb)}" 
               alt="${escapeHtml(comm.name)}" 
               class="community-card-avatar"
               onerror="this.src='https://via.placeholder.com/60?text=C'">
          <div class="community-card-info">
            <div class="community-card-name">${escapeHtml(comm.name || 'Unnamed Community')}</div>
            <div class="community-card-members">${comm.member_count || 0} members</div>
          </div>
        </div>
      `;
    }).join('');

    updateCommunityListHeader();
  }

  function updateCommunityListHeader(){
    const currentComm = allCommunities.find(c => String(c.id) === String(COMM_ID));
    const titleEl = document.getElementById('currentCommunityName');
    const statsEl = document.getElementById('currentCommunityStats');
    
    if(currentComm){
      if(titleEl) titleEl.textContent = currentComm.name || 'Community';
      if(statsEl) statsEl.textContent = 
        `${currentComm.member_count || 0} Members ¬∑ ${currentComm.online_count || 0} Online`;
    }
  }

  window.selectCommunity = function(commId){
    COMM_ID = commId;
    const url = new URL(location.href);
    url.searchParams.set('community', COMM_ID);
    history.replaceState(null, '', url);
    
    renderCommunitiesList();
    updateSidebarLinks();
    loadCommunity();
    loadChannels();
    loadEvents();
    loadPosts();
  };

  function updateSidebarLinks(){
    document.querySelectorAll('.sidebar-menu a').forEach(a=>{
      const url = new URL(a.getAttribute('href'), location.origin);
      url.searchParams.set('community', COMM_ID);
      a.setAttribute('href', url.pathname + '?' + url.searchParams.toString());
    });
  }

  if(!COMM_ID){
    loadCommunitiesList().then(() => {
      if(COMM_ID){
        document.getElementById('needCommunity').style.display = 'none';
        boot();
      } else {
        document.getElementById('needCommunity').style.display = 'block';
      }
    });
  } else {
    loadCommunitiesList();
    boot();
  }

  async function loadCommunity(){
    if(!COMM_ID) return;
    try{
      const c = await fetchJSON(`${API_BASE}/communities/${COMM_ID}/`);
      const pageName = document.querySelector('[data-page="name"]');
      const pageCnts = document.querySelector('[data-page="counts"]');
      const sImg = document.querySelector('[data-rs="image"]');
      const sNm = document.querySelector('[data-rs="name"]');
      const sCt = document.querySelector('[data-rs="counts"]');
      if(pageName) pageName.textContent = c.name || 'Community Feeds';
      const counts = `${c.member_count||0} Members, ${c.online_count||0} Online`;
      if(pageCnts) pageCnts.textContent = counts;
      if(sImg) sImg.src = abs(c.background_banner || c.profile_pic);
      if(sNm) sNm.textContent = c.name || 'Community';
      if(sCt) sCt.textContent = counts;
    }catch(e){console.warn('Community load failed', e);}
  }

  async function loadChannels(){
    if(!COMM_ID) return;
    const list = document.getElementById('channels-list');
    try{
      const data = await fetchJSON(`${API_BASE}/channels/`);
      const allChannels = Array.isArray(data) ? data : (data.results||[]);
      const items = allChannels.filter(c => String(c.community) === String(COMM_ID));
      list.innerHTML = items.length
        ? items.map(c=>`<a class="channel-item" href="/chat/?channel=${encodeURIComponent(c.id)}&community=${encodeURIComponent(COMM_ID)}">üí¨ ${escapeHtml(c.name)}</a>`).join('')
        : '<div class="empty">No channels</div>';
    }catch(e){
      console.warn('Channels load failed', e);
      list.innerHTML = '<div class="empty">Gagal memuat channels</div>';
    }
  }

  async function loadEvents(){
    if(!COMM_ID) return;
    const list = document.getElementById('events-list');
    try{
      const data = await fetchJSON(`${API_BASE}/events/`);
      const items = Array.isArray(data) ? data : (data.results||data||[]);
      const events = items.filter(e => (e.community && (String(e.community.id||e.community) === String(COMM_ID))));
      list.innerHTML = events.length
        ? events.map(e=>`<a class="event-item" href="/event-info/?community=${encodeURIComponent(COMM_ID)}#${e.id}">üìÖ ${escapeHtml(e.name)}</a>`).join('')
        : '<div class="empty">No events</div>';
    }catch(e){
      console.warn('Events load failed', e);
      list.innerHTML = '<div class="empty">Gagal memuat events</div>';
    }
  }

  async function loadPosts(){
    if(!COMM_ID) return;
    spinner.style.display = 'block';
    try{
      const url = `${API_BASE}/posts/?community=${encodeURIComponent(COMM_ID)}`;
      const data = await fetchJSON(url);
      const posts = Array.isArray(data) ? data : (data.results || []);
      allPosts = posts.filter(p => {
        if(p.community){
          const commId = p.community.id || p.community;
          return String(commId) === String(COMM_ID);
        }
        return false;
      });
      renderPosts();
    }catch(e){
      feedEl.innerHTML = '<div class="empty">Gagal memuat posts.</div>';
      console.warn('Posts load failed', e);
    }finally{
      spinner.style.display = 'none';
    }
  }

  function sortPosts(posts, sortType){
    const sorted = [...posts];
    if(sortType === 'newest'){
      sorted.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
    } else if(sortType === 'oldest'){
      sorted.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
    } else if(sortType === 'popular'){
      sorted.sort((a,b) => (b.like_count||0) - (a.like_count||0));
    }
    return sorted;
  }

  function renderPosts(){
    const sorted = sortPosts(allPosts, currentSort);
    if(!sorted.length){
      feedEl.innerHTML = '<div class="empty">Belum ada posting.</div>';
      return;
    }
    feedEl.innerHTML = sorted.map(p => {
      const author = p.posted_by?.username || p.posted_by?.email || 'Anon';
      const avatar = abs(p.posted_by?.profile_pic);
      const when = p.created_at ? new Date(p.created_at).toLocaleDateString() : '';
      const img = abs(p.image);
      const caption = p.caption || '';
      return `
        <article class="feed-card" onclick="openPostModal('${p.id}')">
          ${img ? `<img class="feed-card-img" src="${img}" alt="post">` : ''}
          <div class="feed-card-content">
            <div class="feed-card-author">
              <img class="feed-card-avatar" src="${avatar||'https://via.placeholder.com/28'}" alt="${escapeHtml(author)}">
              <span class="feed-card-name">${escapeHtml(author)}</span>
              <span class="feed-card-time">${when}</span>
            </div>
            ${caption ? `<div class="feed-card-caption">${escapeHtml(caption)}</div>` : ''}
            <div class="feed-card-reactions">
              <span class="reaction-badge">‚ù§Ô∏è ${p.like_count||0}</span>
              <span class="reaction-badge">üí¨ ${p.reaction_count||0}</span>
            </div>
          </div>
        </article>
      `;
    }).join('');
  }

  window.openPostModal = function(postId){
    const post = allPosts.find(p => String(p.id) === String(postId));
    if(!post) return;
    currentPostForModal = post;
    
    const author = post.posted_by?.username || post.posted_by?.email || 'Anon';
    const avatar = abs(post.posted_by?.profile_pic);
    const when = post.created_at ? new Date(post.created_at).toLocaleString() : '';
    const img = abs(post.image);
    const caption = post.caption || 'No caption';
    
    // Determine current user reaction
    const userReaction = post.user_reaction;
    
    document.getElementById('postDetailContent').innerHTML = `
      ${img ? `<div class="post-image-large"><img src="${img}" alt="post"></div>` : ''}
      <div class="post-info">
        <div class="post-author-detail">
          <img class="post-avatar-large" src="${avatar||'https://via.placeholder.com/42'}" alt="${escapeHtml(author)}">
          <div>
            <div class="post-author-name">${escapeHtml(author)}</div>
            <div class="post-author-time">${when}</div>
          </div>
        </div>
        <div class="post-caption-full">${escapeHtml(caption)}</div>
        <div class="post-reactions-full">
          ${REACTIONS.map(r => `
            <button class="reaction-btn ${userReaction === r.type ? 'active' : ''}" 
                    data-reaction="${r.type}"
                    onclick="reactToPost('${post.id}', '${r.type}')">
              ${r.emoji} ${r.label}
            </button>
          `).join('')}
        </div>
      </div>
    `;
    document.getElementById('postModal').classList.add('active');
  };

  window.closePostModal = function(){
    document.getElementById('postModal').classList.remove('active');
    currentPostForModal = null;
  };

  window.reactToPost = async function(postId, reactionType){
    try{
      const response = await fetch(`${API_BASE}/posts/${postId}/react/`, {
        method: 'POST',
        headers: HEADERS,
        body: JSON.stringify({ reaction_type: reactionType })
      });
      
      if(!response.ok) throw new Error('Failed to react');
      
      const data = await response.json();
      
      // Update the post in allPosts array
      const postIndex = allPosts.findIndex(p => String(p.id) === String(postId));
      if(postIndex !== -1){
        if(data.message.includes('removed')){
          allPosts[postIndex].user_reaction = null;
        } else {
          allPosts[postIndex].user_reaction = reactionType;
        }
        
        // Update currentPostForModal if it exists
        if(currentPostForModal && String(currentPostForModal.id) === String(postId)){
          currentPostForModal.user_reaction = allPosts[postIndex].user_reaction;
        }
      }
      
      // Reload posts and re-render
      await loadPosts();
      
      // If modal is open, refresh it
      if(currentPostForModal){
        openPostModal(postId);
      }
      
    }catch(e){
      console.warn('Reaction failed', e);
      alert('Failed to react to post');
    }
  };

  document.getElementById('createPostBtn').addEventListener('click', ()=>{
    document.getElementById('createPostModal').classList.add('active');
  });

  window.closeCreatePostModal = function(){
    document.getElementById('createPostModal').classList.remove('active');
    document.getElementById('captionInput').value = '';
    document.getElementById('uploadArea').classList.remove('has-image');
    document.getElementById('uploadArea').innerHTML = `
      <div class="upload-icon">üñºÔ∏è üé•</div>
      <div class="upload-text">Drag photos and videos here</div>
      <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Select from computer</button>
      <input type="file" id="fileInput" accept="image/*" style="display:none">
    `;
    selectedFile = null;
    document.getElementById('fileInput').addEventListener('change', handleFileChange);
  };

  function handleFileChange(e){
    const file = e.target.files[0];
    if(file){
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        const area = document.getElementById('uploadArea');
        area.classList.add('has-image');
        area.innerHTML = `<img class="preview-image" src="${ev.target.result}" alt="preview">`;
      };
      reader.readAsDataURL(file);
    }
  }

  document.getElementById('fileInput').addEventListener('change', handleFileChange);

  document.getElementById('submitPost').addEventListener('click', async ()=>{
    const caption = document.getElementById('captionInput').value.trim();
    if(!caption && !selectedFile){
      alert('Tambahkan caption atau gambar!');
      return;
    }
    const formData = new FormData();
    formData.append('community_uuid', COMM_ID);
    formData.append('caption', caption);
    if(selectedFile) formData.append('image', selectedFile);
    try{
      const headers = ACCESS ? {Authorization:`Bearer ${ACCESS}`} : {};
      const r = await fetch(`${API_BASE}/posts/`, {
        method: 'POST',
        headers: headers,
        body: formData
      });
      if(!r.ok){
        const err = await r.json();
        throw new Error(JSON.stringify(err));
      }
      closeCreatePostModal();
      await loadPosts();
    }catch(e){
      console.error('Post creation failed', e);
      alert('Gagal membuat post: ' + e.message);
    }
  });

  document.getElementById('sortBtn').addEventListener('click', ()=>{
    document.getElementById('sortMenu').classList.toggle('active');
  });

  document.querySelectorAll('.sort-option').forEach(opt=>{
    opt.addEventListener('click', ()=>{
      document.querySelectorAll('.sort-option').forEach(o=>o.classList.remove('active'));
      opt.classList.add('active');
      currentSort = opt.getAttribute('data-sort');
      renderPosts();
      document.getElementById('sortMenu').classList.remove('active');
    });
  });

  document.getElementById('q').addEventListener('input', (e)=>{
    const query = e.target.value.toLowerCase();
    if(!query){
      renderPosts();
      return;
    }
    const filtered = allPosts.filter(p => 
      (p.caption||'').toLowerCase().includes(query) ||
      (p.posted_by?.username||'').toLowerCase().includes(query) ||
      (p.posted_by?.email||'').toLowerCase().includes(query)
    );
    const sorted = sortPosts(filtered, currentSort);
    feedEl.innerHTML = sorted.length ? sorted.map(p => {
      const author = p.posted_by?.username || p.posted_by?.email || 'Anon';
      const avatar = abs(p.posted_by?.profile_pic);
      const when = p.created_at ? new Date(p.created_at).toLocaleDateString() : '';
      const img = abs(p.image);
      const caption = p.caption || '';
      return `
        <article class="feed-card" onclick="openPostModal('${p.id}')">
          ${img ? `<img class="feed-card-img" src="${img}" alt="post">` : ''}
          <div class="feed-card-content">
            <div class="feed-card-author">
              <img class="feed-card-avatar" src="${avatar||'https://via.placeholder.com/28'}" alt="${escapeHtml(author)}">
              <span class="feed-card-name">${escapeHtml(author)}</span>
              <span class="feed-card-time">${when}</span>
            </div>
            ${caption ? `<div class="feed-card-caption">${escapeHtml(caption)}</div>` : ''}
            <div class="feed-card-reactions">
              <span class="reaction-badge">‚ù§Ô∏è ${p.like_count||0}</span>
              <span class="reaction-badge">üí¨ ${p.reaction_count||0}</span>
            </div>
          </div>
        </article>
      `;
    }).join('') : '<div class="empty">Tidak ada hasil pencarian.</div>';
  });

  function boot(){
    updateSidebarLinks();
    Promise.all([loadCommunity(), loadChannels(), loadEvents()]).then(()=>{
      loadPosts();
    });
  }
})();
</script>
</body>
</html>